<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
		<link rel="stylesheet" href="/iframe/style.css" />
		<title>PCBç¦»çº¿è®¡ä»·å·¥å…·</title>
	</head>
	<body>
		<div class="container">
			<!-- ä¾§è¾¹æ  -->
			<aside class="sidebar">
				<h3>è®¡ä»·è§„åˆ™</h3>
				<div id="rulesList">
					<div class="rule-item active" data-rule-id="default">
						<div class="rule-name">é»˜è®¤è§„åˆ™</div>
						<div class="rule-type">æŒ‰é¢ç§¯è®¡ä»·</div>
					</div>
				</div>
				<button class="btn btn-secondary" style="width: 100%; margin-top: 20px" onclick="showNewRuleModal()">+ æ–°å»ºè§„åˆ™</button>
			</aside>

			<!-- ä¸»å†…å®¹åŒº -->
			<main class="main-content">
				<!-- å·¥å…·æ  -->
				<div class="toolbar">
					<div class="toolbar-left">
						<button class="btn btn-primary" onclick="GetPcbInfomation()">ğŸ“ è¯†åˆ«PCBä¿¡æ¯</button>
						<button class="btn btn-secondary" onclick="calculatePrice()">ğŸ’° è®¡ç®—ä»·æ ¼</button>
					</div>
					<div class="toolbar-right">
						<button class="btn btn-secondary" onclick="exportRules()">ğŸ“¤ å¯¼å‡ºè§„åˆ™</button>
						<button class="btn btn-secondary" onclick="importRules()">ğŸ“¥ å¯¼å…¥è§„åˆ™</button>
					</div>
				</div>

				<!-- å†…å®¹åŒºåŸŸ -->
				<div class="content-area">
					<!-- å·¦ä¾§é¢æ¿ - PCBå‚æ•° -->
					<div class="left-panel">
						<div class="form-section">
							<h3>åŸºæœ¬ä¿¡æ¯</h3>

							<div class="form-group">
								<label for="board-type">æ¿æç±»åˆ«</label>
								<select id="board-type" class="form-control">
									<option value="fpc">FPCè½¯æ¿</option>
									<option value="fr4" selected>FR-4</option>
									<option value="aluminum">é“åŸºæ¿</option>
									<option value="copper">é“œåŸºæ¿</option>
									<option value="rogers">ç½—æ°æ–¯é«˜é¢‘æ¿</option>
									<option value="ptfe">é“æ°Ÿé¾™é«˜é¢‘æ¿</option>
								</select>
							</div>

							<div class="form-group">
								<label>æ¿å­å°ºå¯¸</label>
								<div class="input-group">
									<input type="number" id="length-input" class="form-control" placeholder="é•¿" />
									<span class="unit">CM</span>
									<input type="number" id="width-input" class="form-control" placeholder="å®½" />
									<span class="unit">CM</span>
								</div>
							</div>

							<div class="form-group">
								<label>æ¿å­å±‚æ•°</label>
								<div class="input-group">
									<input type="number" id="layer-input" class="form-control" />
									<span class="unit">å±‚</span>
								</div>
							</div>

							<div class="form-group">
								<label for="product-type">äº§å“ç±»å‹</label>
								<select id="product-type" class="form-control">
									<option value="others">å·¥ä¸š/æ¶ˆè´¹/å…¶ä»–ç±»ç”µå­äº§å“</option>
									<option value="aviation">èˆªç©º</option>
									<option value="help">åŒ»ç–—</option>
								</select>
							</div>

							<div class="form-group">
								<label>ç¡®è®¤ç”Ÿäº§ç¨¿</label>
								<div class="input-group">
									<input type="number" id="verify-group" class="form-control" placeholder="ä¸éœ€è¦åˆ™æ”¾ç©º" />
									<span class="unit">æ¬¡</span>
								</div>
							</div>
						</div>

						<div class="form-section">
							<h3>PCBå·¥è‰º</h3>
							<div id="processList">
								<!-- åŠ¨æ€ç”Ÿæˆçš„å·¥è‰ºé¡¹ -->
							</div>
							<button class="btn btn-secondary" style="width: 100%; margin-top: 10px" onclick="showAddProcessModal()">
								+ æ·»åŠ è‡ªå®šä¹‰å·¥è‰º
							</button>
						</div>
					</div>

					<!-- å³ä¾§é¢æ¿ - è®¡ä»·è§„åˆ™ -->
					<div class="right-panel">
						<div class="form-section">
							<h3>è®¡ä»·æ–¹å¼</h3>
							<div class="tabs">
								<button class="tab active" onclick="switchTab('area')">æŒ‰é¢ç§¯è®¡ä»·</button>
								<button class="tab" onclick="switchTab('fixed')">ä¸€æ¬¡æ€§ä»˜è´¹</button>
								<button class="tab" onclick="switchTab('free')">å…è´¹</button>
							</div>

							<div id="area-tab" class="tab-content active">
								<div class="form-group">
									<label>åŸºç¡€ä»·æ ¼ (å…ƒ/å¹³æ–¹å˜ç±³)</label>
									<input type="number" id="base-price-area" class="form-control" value="0.5" step="0.01" />
								</div>
								<div class="form-group">
									<label>é™„åŠ ä»·æ ¼ (å…ƒ)</label>
									<input type="number" id="extra-price-area" class="form-control" value="10" step="0.01" />
								</div>
								<p style="color: #5a6c7d; font-size: 14px; margin-top: 10px">è®¡ç®—å…¬å¼ï¼š(åŸºç¡€ä»·æ ¼ Ã— é¢ç§¯) + é™„åŠ ä»·æ ¼</p>
							</div>

							<div id="fixed-tab" class="tab-content">
								<div class="form-group">
									<label>åŸºç¡€ä»·æ ¼ (å…ƒ)</label>
									<input type="number" id="base-price-fixed" class="form-control" value="100" step="0.01" />
								</div>
								<div class="form-group">
									<label>é¢ç§¯ç³»æ•°</label>
									<input type="number" id="area-factor" class="form-control" value="0.1" step="0.01" />
								</div>
								<p style="color: #5a6c7d; font-size: 14px; margin-top: 10px">è®¡ç®—å…¬å¼ï¼šåŸºç¡€ä»·æ ¼ + (é¢ç§¯ç³»æ•° Ã— é¢ç§¯)</p>
							</div>

							<div id="free-tab" class="tab-content">
								<p style="color: #5a6c7d; font-size: 14px">æ­¤è§„åˆ™ä¸‹æ‰€æœ‰è®¢å•å…è´¹</p>
							</div>
						</div>

						<div class="form-section">
							<h3>æ¡ä»¶è§„åˆ™</h3>
							<div id="conditionsList">
								<!-- åŠ¨æ€ç”Ÿæˆçš„æ¡ä»¶è§„åˆ™ -->
							</div>
							<button class="btn btn-secondary" style="width: 100%; margin-top: 10px" onclick="addCondition()">+ æ·»åŠ æ¡ä»¶è§„åˆ™</button>
						</div>
					</div>
				</div>
			</main>
		</div>

		<!-- å›ºå®šåœ¨åº•éƒ¨çš„ä»·æ ¼æ˜¾ç¤º -->
		<div class="price-display-fixed">
			<div class="price-label">é¢„ä¼°ä»·æ ¼</div>
			<div class="price-value" id="finalPrice">Â¥0.00</div>
		</div>

		<!-- æ–°å»ºè§„åˆ™æ¨¡æ€æ¡† -->
		<div id="newRuleModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>æ–°å»ºè®¡ä»·è§„åˆ™</h3>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label>è§„åˆ™åç§°</label>
						<input type="text" id="newRuleName" class="form-control" placeholder="è¾“å…¥è§„åˆ™åç§°" />
					</div>
					<div class="form-group">
						<label>è®¡ä»·æ–¹å¼</label>
						<select id="newRuleType" class="form-control">
							<option value="area">æŒ‰é¢ç§¯è®¡ä»·</option>
							<option value="fixed">ä¸€æ¬¡æ€§ä»˜è´¹</option>
							<option value="free">å…è´¹</option>
						</select>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeModal('newRuleModal')">å–æ¶ˆ</button>
					<button class="btn btn-primary" onclick="createNewRule()">åˆ›å»º</button>
				</div>
			</div>
		</div>

		<!-- æ·»åŠ å·¥è‰ºæ¨¡æ€æ¡† -->
		<div id="addProcessModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>æ·»åŠ è‡ªå®šä¹‰å·¥è‰º</h3>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label>å·¥è‰ºåç§°</label>
						<input type="text" id="processName" class="form-control" placeholder="è¾“å…¥å·¥è‰ºåç§°" />
					</div>
					<div class="form-group">
						<label>è¾“å…¥ç±»å‹</label>
						<select id="processType" class="form-control" onchange="toggleProcessInput()">
							<option value="select">ä¸‹æ‹‰é€‰æ‹©</option>
							<option value="input">æ•°å€¼è¾“å…¥</option>
							<option value="color">é¢œè‰²é€‰æ‹©</option>
						</select>
					</div>
					<div class="form-group" id="processOptionsGroup">
						<label>é€‰é¡¹å€¼ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
						<textarea id="processOptions" class="form-control" rows="4" placeholder="é€‰é¡¹1&#10;é€‰é¡¹2&#10;é€‰é¡¹3"></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeModal('addProcessModal')">å–æ¶ˆ</button>
					<button class="btn btn-primary" onclick="addCustomProcess()">æ·»åŠ </button>
				</div>
			</div>
		</div>

		<!-- ç¼–è¾‘å·¥è‰ºæ¨¡æ€æ¡† -->
		<div id="editProcessModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>ç¼–è¾‘è‡ªå®šä¹‰å·¥è‰º</h3>
				</div>
				<div class="modal-body">
					<input type="hidden" id="editProcessId" />
					<div class="form-group">
						<label>å·¥è‰ºåç§°</label>
						<input type="text" id="editProcessName" class="form-control" placeholder="è¾“å…¥å·¥è‰ºåç§°" />
					</div>
					<div class="form-group">
						<label>è¾“å…¥ç±»å‹</label>
						<select id="editProcessType" class="form-control" onchange="toggleEditProcessInput()">
							<option value="select">ä¸‹æ‹‰é€‰æ‹©</option>
							<option value="input">æ•°å€¼è¾“å…¥</option>
							<option value="color">é¢œè‰²é€‰æ‹©</option>
						</select>
					</div>
					<div class="form-group" id="editProcessOptionsGroup" style="display: none">
						<label>é€‰é¡¹å€¼ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
						<textarea id="editProcessOptions" class="form-control" rows="4" placeholder="é€‰é¡¹1&#10;é€‰é¡¹2&#10;é€‰é¡¹3"></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeModal('editProcessModal')">å–æ¶ˆ</button>
					<button class="btn btn-primary" onclick="saveEditProcess()">ä¿å­˜</button>
				</div>
			</div>
		</div>
	</body>

	<script>
		// å…¨å±€å˜é‡
		// allRules å°†ä½œä¸ºå”¯ä¸€çš„æ•°æ®æºï¼Œå­˜å‚¨æ‰€æœ‰è§„åˆ™
		let allRules = {
			'default': {
				id: 'default',
				name: 'é»˜è®¤è§„åˆ™',
				type: 'area',
				basePrice: 0.5,
				extraPrice: 10,
				conditions: [],
				customProcesses: [], // æ¯ä¸ªè§„åˆ™éƒ½æœ‰è‡ªå·±çš„è‡ªå®šä¹‰å·¥è‰º
			},
		};
		// currentRuleId åªå­˜å‚¨å½“å‰é€‰ä¸­è§„åˆ™çš„ID
		let currentRuleId = 'default';

		let allProcesses = [];

		// åˆå§‹åŒ–
		document.addEventListener('DOMContentLoaded', function () {
			initializeProcesses();
			renderProcesses();
			renderRulesList(); // æ–°å¢ï¼šç»Ÿä¸€æ¸²æŸ“è§„åˆ™åˆ—è¡¨
			selectRule('default'); // åˆå§‹åŒ–æ—¶é€‰ä¸­é»˜è®¤è§„åˆ™
			renderConditions();
		});

		// åˆå§‹åŒ–å·¥è‰ºåˆ—è¡¨
		function initializeProcesses() {
			allProcesses = [
				{
					id: 'put_together',
					name: 'æ‹¼æ¿æ¬¾æ•°',
					type: 'input',
					unit: 'ä¸ª',
				},
				{
					id: 'delivery',
					name: 'å‡ºè´§æ–¹å¼',
					type: 'select',
					options: ['å•ç‰‡', 'æ‹¼æ¿'],
				},
				{
					id: 'copper_thick',
					name: 'å¤–å±‚é“œåš',
					type: 'input',
					unit: 'ç›å¸',
				},
				{
					id: 'soldermask_color',
					name: 'é˜»ç„Šé¢œè‰²',
					type: 'color',
					default: '#2E8B57',
				},
				{
					id: 'content_color',
					name: 'å­—ç¬¦é¢œè‰²',
					type: 'color',
					default: '#ffffff',
				},
				{
					id: 'solder_cover',
					name: 'é˜»ç„Šè¦†ç›–',
					type: 'select',
					options: ['è¿‡å­”ç›–æ²¹', 'è¿‡å­”å¼€çª—', 'è¿‡å­”å¡æ²¹', 'è¿‡å­”å¡æ ‘è„‚+è¿‡å­”ç”µé•€ç›–å¸½', 'è¿‡å­”å¡é“œæµ†+è¿‡å­”ç”µé•€ç›–å¸½'],
				},
				{
					id: 'solder_cover_type',
					name: 'ç„Šç›˜å–·é”¡',
					type: 'select',
					options: ['æœ‰é“…å–·é”¡', 'æ— é“…å–·é”¡', 'æ²‰é‡‘'],
				},
				{
					id: 'min_hole_diameter',
					name: 'æœ€å°å­”å¾„/å¤–å¾„',
					type: 'select',
					options: ['0.3mm(å¤–å¾„0.4/0.45)', '0.25mm(å¤–å¾„0.35/0.4)', '0.2mm(å¤–å¾„0.3/0.35)', '0.15mm(å¤–å¾„0.25/0.3)'],
				},
				{
					id: 'gold_finger_bevel',
					name: 'é‡‘(é”¡)æ‰‹æŒ‡æ–œè¾¹',
					type: 'select',
					options: ['ä¸éœ€è¦', 'éœ€è¦'],
				},
				{
					id: 'line_test',
					name: 'çº¿è·¯æµ‹è¯•',
					type: 'select',
					options: ['AOIå…¨æµ‹+é£é’ˆå…¨æµ‹'],
				},
			];
		}

		// æ¸²æŸ“å·¥è‰ºåˆ—è¡¨
		function renderProcesses() {
			const processList = document.getElementById('processList');
			processList.innerHTML = '';

			// è·å–å½“å‰è§„åˆ™çš„è‡ªå®šä¹‰å·¥è‰º
			const currentRule = allRules[currentRuleId];
			const currentCustomProcesses = currentRule ? currentRule.customProcesses : [];

			[...allProcesses, ...currentCustomProcesses].forEach((process) => {
				const processItem = document.createElement('div');
				processItem.className = 'process-item';
				processItem.innerHTML = `
		          <div class="process-name">${process.name}</div>
		          <div class="process-control">
		              ${renderProcessControl(process)}
		          </div>
		          ${
				process.custom
					? `
		              <div class="process-actions">
		                  <button class="icon-btn" onclick="editProcess('${process.id}')">âœï¸</button>
		                  <button class="icon-btn" onclick="deleteProcess('${process.id}')">ğŸ—‘ï¸</button>
		              </div>
		          `
					: ''
			}
		      `;
				processList.appendChild(processItem);
			});
		}

		// æ¸²æŸ“å·¥è‰ºæ§ä»¶
		function renderProcessControl(process) {
			switch (process.type) {
				case 'select':
					return `<select id="process-${process.id}" class="form-control">
		              ${process.options.map((opt) => `<option value="${opt}">${opt}</option>`).join('')}
		          </select>`;
				case 'input':
					return `<div class="input-group">
		              <input type="number" id="process-${process.id}" class="form-control" placeholder="è¾“å…¥æ•°å€¼">
		              ${process.unit ? `<span class="unit">${process.unit}</span>` : ''}
		          </div>`;
				case 'color':
					return `<div class="color-picker-wrapper">
		              <input type="color" id="process-${process.id}" class="color-picker" value="${process.default || '#000000'}">
		              <span>${process.default || '#000000'}</span>
		          </div>`;
				default:
					return '';
			}
		}

		// æ·»åŠ æ¡ä»¶è§„åˆ™
		function addCondition() {
			const condition = {
				id: Date.now(),
				process: '',
				operator: '=',
				value: '',
				action: '+',
				amount: 0,
			};
			// é€šè¿‡ currentRuleId è·å–å½“å‰è§„åˆ™
			allRules[currentRuleId].conditions.push(condition);
			renderConditions();
		}

		// æ¸²æŸ“æ¡ä»¶è§„åˆ™
		function renderConditions() {
			const conditionsList = document.getElementById('conditionsList');
			conditionsList.innerHTML = '';

			const currentRule = allRules[currentRuleId];
			if (!currentRule || currentRule.conditions.length === 0) {
				conditionsList.innerHTML = '<p style="color: #5a6c7d; text-align: center;">æš‚æ— æ¡ä»¶è§„åˆ™</p>';
				return;
			}

			currentRule.conditions.forEach((condition) => {
				const conditionDiv = document.createElement('div');
				conditionDiv.className = 'condition-rule';
				conditionDiv.innerHTML = `
		          <div class="condition-header">
		              <span class="condition-title">æ¡ä»¶è§„åˆ™ #${condition.id}</span>
		              <button class="icon-btn" onclick="removeCondition(${condition.id})">âŒ</button>
		          </div>
		          <div class="condition-body">
		              <span>å¦‚æœ</span>
		              <select class="condition-select" onchange="updateCondition(${condition.id}, 'process', this.value)">
		                  <option value="">é€‰æ‹©å·¥è‰º</option>
		                  ${[...allProcesses, ...(currentRule.customProcesses || [])]
						.map((p) => `<option value="${p.id}" ${condition.process === p.id ? 'selected' : ''}>${p.name}</option>`)
						.join('')}
		              </select>
		              <select class="condition-select" onchange="updateCondition(${condition.id}, 'operator', this.value)">
		                  <option value="=" ${condition.operator === '=' ? 'selected' : ''}>=</option>
		                  <option value=">" ${condition.operator === '>' ? 'selected' : ''}>></option>
		                  <option value="<" ${condition.operator === '<' ? 'selected' : ''}><</option>
		                  <option value=">=" ${condition.operator === '>=' ? 'selected' : ''}>>=</option>
		                  <option value="<=" ${condition.operator === '<=' ? 'selected' : ''}<=</option>
		              </select>
		              <input type="text" class="condition-input" placeholder="å€¼" value="${condition.value}"
		                     onchange="updateCondition(${condition.id}, 'value', this.value)">
		              <span>åˆ™ä»·æ ¼</span>
		              <select class="condition-select" onchange="updateCondition(${condition.id}, 'action', this.value)">
		                  <option value="+" ${condition.action === '+' ? 'selected' : ''}>+</option>
		                  <option value="-" ${condition.action === '-' ? 'selected' : ''}>-</option>
		                  <option value="*" ${condition.action === '*' ? 'selected' : ''}>Ã—</option>
		                  <option value="/" ${condition.action === '/' ? 'selected' : ''}>Ã·</option>
		              </select>
		              <input type="number" class="condition-input" placeholder="é‡‘é¢" value="${condition.amount}"
		                     onchange="updateCondition(${condition.id}, 'amount', this.value)">
		          </div>
		      `;
				conditionsList.appendChild(conditionDiv);
			});
		}

		// æ›´æ–°æ¡ä»¶
		function updateCondition(id, field, value) {
			const condition = allRules[currentRuleId].conditions.find((c) => c.id === id);
			if (condition) {
				condition[field] = field === 'amount' ? parseFloat(value) || 0 : value;
			}
		}

		// åˆ é™¤æ¡ä»¶
		function removeCondition(id) {
			allRules[currentRuleId].conditions = allRules[currentRuleId].conditions.filter((c) => c.id !== id);
			renderConditions();
		}

		// åˆ‡æ¢æ ‡ç­¾é¡µ
		function switchTab(tab) {
			document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));

			event.target.classList.add('active');
			document.getElementById(`${tab}-tab`).classList.add('active');

			// æ›´æ–°å½“å‰è§„åˆ™çš„ç±»å‹
			allRules[currentRuleId].type = tab;
		}

		function toggleEditProcessInput() {
			const type = document.getElementById('editProcessType').value;
			const optionsGroup = document.getElementById('editProcessOptionsGroup');
			optionsGroup.style.display = type === 'select' ? 'block' : 'none';
		}

		// è®¡ç®—ä»·æ ¼
		function calculatePrice() {
			const length = parseFloat(document.getElementById('length-input').value) || 0;
			const width = parseFloat(document.getElementById('width-input').value) || 0;
			const area = length * width;

			let price = 0;
			const currentRule = allRules[currentRuleId];

			switch (currentRule.type) {
				case 'area':
					const basePrice = parseFloat(document.getElementById('base-price-area').value) || 0;
					const extraPrice = parseFloat(document.getElementById('extra-price-area').value) || 0;
					price = basePrice * area + extraPrice;
					break;
				case 'fixed':
					const fixedBase = parseFloat(document.getElementById('base-price-fixed').value) || 0;
					const areaFactor = parseFloat(document.getElementById('area-factor').value) || 0;
					price = fixedBase + areaFactor * area;
					break;
				case 'free':
					price = 0;
					break;
			}

			// åº”ç”¨æ¡ä»¶è§„åˆ™
			currentRule.conditions.forEach((condition) => {
				const processValue = getProcessValue(condition.process);
				if (evaluateCondition(processValue, condition.operator, condition.value)) {
					switch (condition.action) {
						case '+':
							price += condition.amount;
							break;
						case '-':
							price -= condition.amount;
							break;
						case '*':
							price *= condition.amount;
							break;
						case '/':
							price /= condition.amount;
							break;
					}
				}
			});

			document.getElementById('finalPrice').textContent = `Â¥${price.toFixed(2)}`;
		}

		// è·å–å·¥è‰ºå€¼
		function getProcessValue(processId) {
			const element = document.getElementById(`process-${processId}`);
			return element ? element.value : '';
		}

		// è¯„ä¼°æ¡ä»¶
		function evaluateCondition(actual, operator, expected) {
			if (actual === undefined || actual === null || expected === '') return false;

			const a = parseFloat(actual) || actual;
			const e = parseFloat(expected) || expected;

			switch (operator) {
				case '=':
					return a == e;
				case '>':
					return a > e;
				case '<':
					return a < e;
				case '>=':
					return a >= e;
				case '<=':
					return a <= e;
				default:
					return false;
			}
		}

		// æ˜¾ç¤ºæ–°å»ºè§„åˆ™æ¨¡æ€æ¡†
		function showNewRuleModal() {
			document.getElementById('newRuleModal').classList.add('show');
		}

		// æ˜¾ç¤ºæ·»åŠ å·¥è‰ºæ¨¡æ€æ¡†
		function showAddProcessModal() {
			document.getElementById('addProcessModal').classList.add('show');
		}

		// å…³é—­æ¨¡æ€æ¡†
		function closeModal(modalId) {
			document.getElementById(modalId).classList.remove('show');
		}

		// åˆ›å»ºæ–°è§„åˆ™
		function createNewRule() {
			const name = document.getElementById('newRuleName').value;
			const type = document.getElementById('newRuleType').value;

			if (!name) {
				alert('è¯·è¾“å…¥è§„åˆ™åç§°');
				return;
			}

			const newRule = {
				id: Date.now().toString(),
				name: name,
				type: type,
				basePrice: 0.5,
				extraPrice: 10,
				conditions: [],
				customProcesses: [], // æ¯ä¸ªè§„åˆ™éƒ½æœ‰è‡ªå·±çš„è‡ªå®šä¹‰å·¥è‰º
			};

			// ä¿å­˜åˆ°allRules
			allRules[newRule.id] = newRule;

			// é‡æ–°æ¸²æŸ“è§„åˆ™åˆ—è¡¨
			renderRulesList();

			// ç«‹å³åˆ‡æ¢åˆ°æ–°è§„åˆ™
			selectRule(newRule.id);

			closeModal('newRuleModal');
			document.getElementById('newRuleName').value = '';
		}

		// æ¸²æŸ“è§„åˆ™åˆ—è¡¨ (æ–°å¢å‡½æ•°ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†ä¾§è¾¹æ )
		function renderRulesList() {
			const rulesList = document.getElementById('rulesList');
			rulesList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨

			Object.values(allRules).forEach((rule) => {
				const ruleItem = document.createElement('div');
				ruleItem.className = 'rule-item';
				ruleItem.dataset.ruleId = rule.id;
				ruleItem.innerHTML = `
		          <div class="rule-name">${rule.name}</div>
		          <div class="rule-type">${rule.type === 'area' ? 'æŒ‰é¢ç§¯è®¡ä»·' : rule.type === 'fixed' ? 'ä¸€æ¬¡æ€§ä»˜è´¹' : 'å…è´¹'}</div>
		      `;
				ruleItem.onclick = () => selectRule(rule.id);
				rulesList.appendChild(ruleItem);
			});
		}

		// é€‰æ‹©è§„åˆ™ (å·²ä¿®å¤)
		function selectRule(ruleId) {
			// æ£€æŸ¥è§„åˆ™æ˜¯å¦å­˜åœ¨
			if (!allRules[ruleId]) {
				console.error(`Rule with id ${ruleId} not found.`);
				return;
			}

			// æ›´æ–°å½“å‰è§„åˆ™ID
			currentRuleId = ruleId;
			const currentRule = allRules[currentRuleId];

			// æ›´æ–°UIé€‰ä¸­çŠ¶æ€
			document.querySelectorAll('.rule-item').forEach((item) => item.classList.remove('active'));
			const selectedItem = document.querySelector(`[data-rule-id="${ruleId}"]`);
			if (selectedItem) {
				selectedItem.classList.add('active');
			}

			// æ›´æ–°æ ‡ç­¾é¡µ
			document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));

			const activeTab = document.querySelector(`.tab[data-tab="${currentRule.type}"]`);
			if (activeTab) {
				activeTab.classList.add('active');
				document.getElementById(`${currentRule.type}-tab`).classList.add('active');
			}

			// é‡æ–°æ¸²æŸ“å·¥è‰ºå’Œæ¡ä»¶
			renderProcesses();
			renderConditions();
		}

		// æ·»åŠ è‡ªå®šä¹‰å·¥è‰º
		function addCustomProcess() {
			const name = document.getElementById('processName').value;
			const type = document.getElementById('processType').value;
			const options = document
				.getElementById('processOptions')
				.value.split('\n')
				.filter((o) => o.trim());

			if (!name) {
				alert('è¯·è¾“å…¥å·¥è‰ºåç§°');
				return;
			}

			if (type === 'select' && options.length === 0) {
				alert('è¯·æ·»åŠ é€‰é¡¹å€¼');
				return;
			}

			const process = {
				id: 'custom_' + Date.now(),
				name: name,
				type: type,
				options: options,
				custom: true,
			};

			// æ·»åŠ åˆ°å½“å‰è§„åˆ™çš„è‡ªå®šä¹‰å·¥è‰º
			if (!allRules[currentRuleId].customProcesses) {
				allRules[currentRuleId].customProcesses = [];
			}
			allRules[currentRuleId].customProcesses.push(process);

			renderProcesses();
			renderConditions();

			closeModal('addProcessModal');
			document.getElementById('processName').value = '';
			document.getElementById('processOptions').value = '';
		}

		// åˆ é™¤è‡ªå®šä¹‰å·¥è‰º
		function deleteProcess(processId) {
			if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå·¥è‰ºå—ï¼Ÿ')) {
				const currentRule = allRules[currentRuleId];
				if (currentRule && currentRule.customProcesses) {
					currentRule.customProcesses = currentRule.customProcesses.filter((p) => p.id !== processId);
					renderProcesses();
					renderConditions();
				}
			}
		}

		// ç¼–è¾‘è‡ªå®šä¹‰å·¥è‰º
		function editProcess(processId) {
			const currentRule = allRules[currentRuleId];
			if (!currentRule || !currentRule.customProcesses) return;

			const process = currentRule.customProcesses.find((p) => p.id === processId);
			if (!process) return;

			// å¡«å……ç¼–è¾‘è¡¨å•
			document.getElementById('editProcessId').value = processId;
			document.getElementById('editProcessName').value = process.name;
			document.getElementById('editProcessType').value = process.type;

			// å¦‚æœæ˜¯é€‰æ‹©ç±»å‹ï¼Œæ˜¾ç¤ºé€‰é¡¹
			if (process.type === 'select') {
				document.getElementById('editProcessOptionsGroup').style.display = 'block';
				document.getElementById('editProcessOptions').value = process.options ? process.options.join('\n') : '';
			} else {
				document.getElementById('editProcessOptionsGroup').style.display = 'none';
			}

			// æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
			document.getElementById('editProcessModal').classList.add('show');
		}

		// ä¿å­˜ç¼–è¾‘çš„è‡ªå®šä¹‰å·¥è‰º
		function saveEditProcess() {
			const processId = document.getElementById('editProcessId').value;
			const name = document.getElementById('editProcessName').value;
			const type = document.getElementById('editProcessType').value;
			const options = document
				.getElementById('editProcessOptions')
				.value.split('\n')
				.filter((o) => o.trim());

			if (!name) {
				alert('è¯·è¾“å…¥å·¥è‰ºåç§°');
				return;
			}

			if (type === 'select' && options.length === 0) {
				alert('è¯·æ·»åŠ é€‰é¡¹å€¼');
				return;
			}

			const currentRule = allRules[currentRuleId];
			if (!currentRule || !currentRule.customProcesses) return;

			// æ‰¾åˆ°è¦ç¼–è¾‘çš„å·¥è‰º
			const processIndex = currentRule.customProcesses.findIndex((p) => p.id === processId);
			if (processIndex === -1) return;

			// æ›´æ–°å·¥è‰ºä¿¡æ¯
			currentRule.customProcesses[processIndex] = {
				...currentRule.customProcesses[processIndex],
				name: name,
				type: type,
				options: options,
			};

			renderProcesses();
			renderConditions();

			closeModal('editProcessModal');
		}

		// åˆ‡æ¢å·¥è‰ºè¾“å…¥ç±»å‹ï¼ˆç¼–è¾‘æ¨¡æ€æ¡†ï¼‰
		function toggleEditProcessInput() {
			const type = document.getElementById('editProcessType').value;
			const optionsGroup = document.getElementById('editProcessOptionsGroup');
			optionsGroup.style.display = type === 'select' ? 'block' : 'none';
		}

		// åˆ‡æ¢å·¥è‰ºè¾“å…¥ç±»å‹ï¼ˆæ·»åŠ æ¨¡æ€æ¡†ï¼‰
		function toggleProcessInput() {
			const type = document.getElementById('processType').value;
			const optionsGroup = document.getElementById('processOptionsGroup');
			optionsGroup.style.display = type === 'select' ? 'block' : 'none';
		}

		// å¯¼å‡ºè§„åˆ™
		function exportRules() {
			// 1. åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡æ¥å­˜å‚¨è¦å¯¼å‡ºçš„è§„åˆ™ï¼Œé¿å…ç›´æ¥ä¿®æ”¹åŸå§‹æ•°æ®
			const rulesToExport = { ...allRules };

			// 2. åˆ é™¤é»˜è®¤è§„åˆ™
			if (rulesToExport.default) {
				delete rulesToExport.default;
			}

			// 3. å°†è§„åˆ™å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„ï¼Œç®€åŒ–ç»“æ„
			const exportedRulesArray = Object.values(rulesToExport);

			const exportData = {
				// currentRuleId ç°åœ¨éœ€è¦æ£€æŸ¥å®ƒæ˜¯å¦æ˜¯é»˜è®¤è§„åˆ™ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸å¯¼å‡º
				currentRuleId: currentRuleId !== 'default' && allRules[currentRuleId] ? currentRuleId : null,
				// å°† allRules å¯¹è±¡æ›¿æ¢ä¸º rules æ•°ç»„
				rules: exportedRulesArray,
				timestamp: new Date().toISOString(),
			};

			const blob = new Blob([JSON.stringify(exportData, null, 2)], {
				type: 'application/json',
			});
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `pcb-pricing-rules-${Date.now()}.json`;
			a.click();
			URL.revokeObjectURL(url);
		}

		// å¯¼å…¥è§„åˆ™
		function importRules() {
			const input = document.createElement('input');
			input.type = 'file';
			input.accept = '.json';
			input.onchange = function (e) {
				const file = e.target.files[0];
				if (!file) return;

				const reader = new FileReader();
				reader.onload = function (event) {
					try {
						const data = JSON.parse(event.target.result);

						// 1. å¯¼å…¥è§„åˆ™æ•°ç»„ï¼Œå¹¶å°†å…¶è½¬æ¢å› allRules å¯¹è±¡æ ¼å¼
						if (data.rules && Array.isArray(data.rules)) {
							// å…ˆæ¸…ç©ºç°æœ‰çš„éé»˜è®¤è§„åˆ™
							Object.keys(allRules).forEach((ruleId) => {
								if (ruleId !== 'default') {
									delete allRules[ruleId];
								}
							});

							// å°†å¯¼å…¥çš„è§„åˆ™æ•°ç»„è½¬æ¢å›å¯¹è±¡ï¼Œå¹¶åˆå¹¶åˆ° allRules
							const importedRulesAsObject = data.rules.reduce((acc, rule) => {
								if (rule && rule.id) {
									acc[rule.id] = rule;
								}
								return acc;
							}, {});

							// åˆå¹¶å¯¼å…¥çš„è§„åˆ™ï¼Œä¿ç•™åŸæœ‰çš„é»˜è®¤è§„åˆ™
							allRules = { ...allRules, ...importedRulesAsObject };
						}

						// 3. é€‰ä¸­å¯¼å…¥æ—¶è®°å½•çš„å½“å‰è§„åˆ™
						let newCurrentRuleId = null;
						if (data.currentRuleId && allRules[data.currentRuleId]) {
							newCurrentRuleId = data.currentRuleId;
						} else {
							// å¦‚æœå¯¼å…¥çš„currentRuleIdæ— æ•ˆï¼Œåˆ™å°è¯•é€‰ä¸­ç¬¬ä¸€ä¸ªéé»˜è®¤è§„åˆ™
							const nonDefaultRuleIds = Object.keys(allRules).filter((id) => id !== 'default');
							if (nonDefaultRuleIds.length > 0) {
								newCurrentRuleId = nonDefaultRuleIds[0];
							} else {
								// å¦‚æœæ²¡æœ‰ä»»ä½•éé»˜è®¤è§„åˆ™ï¼Œåˆ™é€‰ä¸­é»˜è®¤è§„åˆ™
								newCurrentRuleId = 'default';
							}
						}

						selectRule(newCurrentRuleId);
						renderRulesList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨

						alert('è§„åˆ™å¯¼å…¥æˆåŠŸ');
					} catch (error) {
						console.error('å¯¼å…¥é”™è¯¯:', error);
						alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
					}
				};
				reader.readAsText(file);
				// æ¸…ç©ºinputå€¼ï¼Œç¡®ä¿å¯ä»¥é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
				input.value = '';
			};
			input.click();
		}

		// PCBè¯†åˆ«å‡½æ•°
		async function GetPcbInfomation() {
			try {
				const ids = await eda.pcb_PrimitivePolyline.getAllPrimitiveId(null, 11);
				eda.pcb_SelectControl.doSelectPrimitives(ids);
				let PCB_Infomation = await eda.pcb_SelectControl.getSelectedPrimitives();
				PCB_Infomation = PCB_Infomation[0];
				let width = PCB_Infomation.width * 0.254;
				let height = PCB_Infomation.height * 0.254;
				const All_Layers = await eda.pcb_Layer.getAllLayers();

				document.getElementById('width-input').value = Math.round((width / 10) * 100) / 100;
				document.getElementById('length-input').value = Math.round((height / 10) * 100) / 100;
				document.getElementById('layer-input').value = calcLayers(All_Layers);
				eda.sys_Message.showToastMessage('è¯†åˆ«æˆåŠŸ', 'success', 2);
				// è‡ªåŠ¨è®¡ç®—ä»·æ ¼
				calculatePrice();
			} catch (error) {
				eda.sys_Message.showToastMessage('æœªè¯†åˆ«åˆ°æ¿æ¡†æˆ–æ¿æ¡†è¿‡å¤šï¼Œè¯·æ‰‹åŠ¨æ¡†é€‰å¹¶é‡è¯•', 'error', 2);
			}
		}

		// è·å–PCBå±‚æ•°
		function calcLayers(layers) {
			let count = 0;
			const ids = [
				1,
				2,
				...Array.from(
					{
						length: 32,
					},
					(_, i) => i + 15,
				),
			];
			for (const layer of layers) {
				const id = parseInt(layer.id);
				if (ids.includes(id) && layer.layerStatus === 1) {
					count++;
				}
			}
			return count;
		}

		// ç›‘å¬é¢œè‰²é€‰æ‹©å™¨å˜åŒ–
		document.addEventListener('change', function (e) {
			if (e.target.type === 'color') {
				const span = e.target.nextElementSibling;
				if (span) {
					span.textContent = e.target.value;
				}
			}
		});
	</script>
</html>
