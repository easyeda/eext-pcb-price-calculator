<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>PCBç¦»çº¿è®¡ä»·å·¥å…·</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
				background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
				min-height: 100vh;
				color: #2c3e50;
			}

			.container {
				display: flex;
				height: 100vh;
				background: white;
			}

			/* ä¾§è¾¹æ æ ·å¼ */
			.sidebar {
				width: 260px;
				background: linear-gradient(180deg, #2c5aa0 0%, #1e3c72 100%);
				color: white;
				padding: 20px;
				overflow-y: auto;
				box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
			}

			.sidebar h3 {
				margin-bottom: 15px;
				font-size: 16px;
				opacity: 0.9;
			}

			.rule-item {
				background: rgba(255, 255, 255, 0.1);
				padding: 12px;
				margin-bottom: 10px;
				border-radius: 8px;
				cursor: pointer;
				transition: all 0.3s ease;
				border: 2px solid transparent;
			}

			.rule-item:hover {
				background: rgba(255, 255, 255, 0.2);
				transform: translateX(5px);
			}

			.rule-item.active {
				background: rgba(255, 255, 255, 0.25);
				border-color: #4fc3f7;
			}

			.rule-name {
				font-weight: 500;
				margin-bottom: 5px;
			}

			.rule-type {
				font-size: 12px;
				opacity: 0.8;
			}

			/* ä¸»å†…å®¹åŒºåŸŸ */
			.main-content {
				flex: 1;
				display: flex;
				flex-direction: column;
				overflow: hidden;
			}

			/* é¡¶éƒ¨å·¥å…·æ  */
			.toolbar {
				background: white;
				padding: 15px 20px;
				border-bottom: 1px solid #e0e6ed;
				display: flex;
				justify-content: space-between;
				align-items: center;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			}

			.toolbar-left {
				display: flex;
				gap: 10px;
			}

			.btn {
				padding: 8px 16px;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				font-size: 14px;
				transition: all 0.3s ease;
				font-weight: 500;
			}

			.btn-primary {
				background: #2c5aa0;
				color: white;
			}

			.btn-primary:hover {
				background: #1e3c72;
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(44, 90, 160, 0.3);
			}

			.btn-secondary {
				background: #f0f4f8;
				color: #2c5aa0;
				border: 1px solid #2c5aa0;
			}

			.btn-secondary:hover {
				background: #e8f0fe;
			}

			.btn-danger {
				background: #ff5252;
				color: white;
			}

			.btn-danger:hover {
				background: #ff1744;
			}

			/* å†…å®¹åŒºåŸŸ */
			.content-area {
				flex: 1;
				display: flex;
				overflow: hidden;
			}

			.left-panel,
			.right-panel {
				flex: 1;
				padding: 20px;
				overflow-y: auto;
			}

			.left-panel {
				border-right: 1px solid #e0e6ed;
				background: #fafbfc;
			}

			.right-panel {
				background: white;
			}

			/* è¡¨å•æ ·å¼ */
			.form-section {
				background: white;
				border-radius: 10px;
				padding: 20px;
				margin-bottom: 20px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
			}

			.form-section h3 {
				color: #2c5aa0;
				margin-bottom: 15px;
				font-size: 18px;
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.form-section h3::before {
				content: '';
				width: 4px;
				height: 20px;
				background: #2c5aa0;
				border-radius: 2px;
			}

			.form-group {
				margin-bottom: 15px;
			}

			.form-group label {
				display: block;
				margin-bottom: 5px;
				color: #5a6c7d;
				font-size: 14px;
				font-weight: 500;
			}

			.form-control {
				width: 100%;
				padding: 8px 12px;
				border: 1px solid #d0d7de;
				border-radius: 6px;
				font-size: 14px;
				transition: all 0.3s ease;
			}

			.form-control:focus {
				outline: none;
				border-color: #2c5aa0;
				box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
			}

			.input-group {
				display: flex;
				gap: 10px;
				align-items: center;
			}

			.input-group .form-control {
				flex: 1;
			}

			.input-group .unit {
				color: #5a6c7d;
				font-size: 14px;
				min-width: 40px;
			}

			/* å·¥è‰ºé¡¹ç›®æ ·å¼ */
			.process-item {
				display: flex;
				align-items: center;
				padding: 10px;
				background: #f8f9fa;
				border-radius: 6px;
				margin-bottom: 10px;
				transition: all 0.3s ease;
			}

			.process-item:hover {
				background: #e8f0fe;
			}

			.process-name {
				flex: 1;
				font-weight: 500;
				color: #2c3e50;
			}

			.process-control {
				flex: 2;
				display: flex;
				gap: 10px;
				align-items: center;
			}

			.process-actions {
				display: flex;
				gap: 5px;
			}

			.icon-btn {
				width: 30px;
				height: 30px;
				border: none;
				background: transparent;
				color: #5a6c7d;
				cursor: pointer;
				border-radius: 4px;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: all 0.3s ease;
			}

			.icon-btn:hover {
				background: #e8f0fe;
				color: #2c5aa0;
			}

			/* æ¡ä»¶è§„åˆ™æ ·å¼ */
			.condition-rule {
				background: #f8f9fa;
				border: 1px solid #e0e6ed;
				border-radius: 8px;
				padding: 15px;
				margin-bottom: 15px;
				position: relative;
			}

			.condition-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 10px;
			}

			.condition-title {
				font-weight: 500;
				color: #2c5aa0;
			}

			.condition-body {
				display: flex;
				gap: 10px;
				align-items: center;
				flex-wrap: wrap;
			}

			.condition-select,
			.condition-input {
				padding: 6px 10px;
				border: 1px solid #d0d7de;
				border-radius: 4px;
				font-size: 14px;
			}

			/* æ¨¡æ€æ¡†æ ·å¼ */
			.modal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.5);
				z-index: 1000;
				align-items: center;
				justify-content: center;
			}

			.modal.show {
				display: flex;
			}

			.modal-content {
				background: white;
				border-radius: 12px;
				padding: 30px;
				max-width: 500px;
				width: 90%;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
				animation: slideIn 0.3s ease;
			}

			@keyframes slideIn {
				from {
					transform: translateY(-50px);
					opacity: 0;
				}

				to {
					transform: translateY(0);
					opacity: 1;
				}
			}

			.modal-header {
				margin-bottom: 20px;
			}

			.modal-header h3 {
				color: #2c5aa0;
				font-size: 20px;
			}

			.modal-body {
				margin-bottom: 20px;
			}

			.modal-footer {
				display: flex;
				justify-content: flex-end;
				gap: 10px;
			}

			/* æ ‡ç­¾é¡µæ ·å¼ */
			.tabs {
				display: flex;
				border-bottom: 2px solid #e0e6ed;
				margin-bottom: 20px;
			}

			.tab {
				padding: 10px 20px;
				background: transparent;
				border: none;
				color: #5a6c7d;
				cursor: pointer;
				font-size: 14px;
				font-weight: 500;
				position: relative;
				transition: all 0.3s ease;
			}

			.tab:hover {
				color: #2c5aa0;
			}

			.tab.active {
				color: #2c5aa0;
			}

			.tab.active::after {
				content: '';
				position: absolute;
				bottom: -2px;
				left: 0;
				right: 0;
				height: 2px;
				background: #2c5aa0;
			}

			.tab-content {
				display: none;
			}

			.tab-content.active {
				display: block;
			}

			/* é¢œè‰²é€‰æ‹©å™¨æ ·å¼ */
			.color-picker-wrapper {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.color-picker {
				width: 50px;
				height: 35px;
				border: 2px solid #d0d7de;
				border-radius: 6px;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.color-picker:hover {
				border-color: #2c5aa0;
			}

			/* ä»·æ ¼æ˜¾ç¤º */
			.price-display {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 20px;
				border-radius: 10px;
				text-align: center;
				margin-top: 20px;
			}

			.price-label {
				font-size: 14px;
				opacity: 0.9;
				margin-bottom: 5px;
			}

			.price-value {
				font-size: 32px;
				font-weight: bold;
			}

			/* å“åº”å¼è®¾è®¡ */
			@media (max-width: 768px) {
				.sidebar {
					width: 200px;
				}

				.content-area {
					flex-direction: column;
				}

				.left-panel,
				.right-panel {
					border-right: none;
					border-bottom: 1px solid #e0e6ed;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<!-- ä¾§è¾¹æ  -->
			<aside class="sidebar">
				<h3>è®¡ä»·è§„åˆ™</h3>
				<div id="rulesList">
					<div class="rule-item active" data-rule-id="default">
						<div class="rule-name">é»˜è®¤è§„åˆ™</div>
						<div class="rule-type">æŒ‰é¢ç§¯è®¡ä»·</div>
					</div>
				</div>
				<button class="btn btn-secondary" style="width: 100%; margin-top: 20px" onclick="showNewRuleModal()">+ æ–°å»ºè§„åˆ™</button>
			</aside>

			<!-- ä¸»å†…å®¹åŒº -->
			<main class="main-content">
				<!-- å·¥å…·æ  -->
				<div class="toolbar">
					<div class="toolbar-left">
						<button class="btn btn-primary" onclick="GetPcbInfomation()">ğŸ“ è¯†åˆ«PCBä¿¡æ¯</button>
						<button class="btn btn-secondary" onclick="calculatePrice()">ğŸ’° è®¡ç®—ä»·æ ¼</button>
					</div>
					<div class="toolbar-right">
						<button class="btn btn-secondary" onclick="exportRules()">ğŸ“¤ å¯¼å‡ºè§„åˆ™</button>
						<button class="btn btn-secondary" onclick="importRules()">ğŸ“¥ å¯¼å…¥è§„åˆ™</button>
					</div>
				</div>

				<!-- å†…å®¹åŒºåŸŸ -->
				<div class="content-area">
					<!-- å·¦ä¾§é¢æ¿ - PCBå‚æ•° -->
					<div class="left-panel">
						<div class="form-section">
							<h3>åŸºæœ¬ä¿¡æ¯</h3>

							<div class="form-group">
								<label for="board-type">æ¿æç±»åˆ«</label>
								<select id="board-type" class="form-control">
									<option value="fpc">FPCè½¯æ¿</option>
									<option value="fr4" selected>FR-4</option>
									<option value="aluminum">é“åŸºæ¿</option>
									<option value="copper">é“œåŸºæ¿</option>
									<option value="rogers">ç½—æ°æ–¯é«˜é¢‘æ¿</option>
									<option value="ptfe">é“æ°Ÿé¾™é«˜é¢‘æ¿</option>
								</select>
							</div>

							<div class="form-group">
								<label>æ¿å­å°ºå¯¸</label>
								<div class="input-group">
									<input type="number" id="length-input" class="form-control" placeholder="é•¿" />
									<span class="unit">CM</span>
									<input type="number" id="width-input" class="form-control" placeholder="å®½" />
									<span class="unit">CM</span>
								</div>
							</div>

							<div class="form-group">
								<label>æ¿å­å±‚æ•°</label>
								<div class="input-group">
									<input type="number" id="layer-input" class="form-control" />
									<span class="unit">å±‚</span>
								</div>
							</div>

							<div class="form-group">
								<label for="product-type">äº§å“ç±»å‹</label>
								<select id="product-type" class="form-control">
									<option value="others">å·¥ä¸š/æ¶ˆè´¹/å…¶ä»–ç±»ç”µå­äº§å“</option>
									<option value="aviation">èˆªç©º</option>
									<option value="help">åŒ»ç–—</option>
								</select>
							</div>

							<div class="form-group">
								<label>ç¡®è®¤ç”Ÿäº§ç¨¿</label>
								<div class="input-group">
									<input type="number" id="verify-group" class="form-control" placeholder="ä¸éœ€è¦åˆ™æ”¾ç©º" />
									<span class="unit">æ¬¡</span>
								</div>
							</div>
						</div>

						<div class="form-section">
							<h3>PCBå·¥è‰º</h3>
							<div id="processList">
								<!-- åŠ¨æ€ç”Ÿæˆçš„å·¥è‰ºé¡¹ -->
							</div>
							<button class="btn btn-secondary" style="width: 100%; margin-top: 10px" onclick="showAddProcessModal()">
								+ æ·»åŠ è‡ªå®šä¹‰å·¥è‰º
							</button>
						</div>
					</div>

					<!-- å³ä¾§é¢æ¿ - è®¡ä»·è§„åˆ™ -->
					<div class="right-panel">
						<div class="form-section">
							<h3>è®¡ä»·æ–¹å¼</h3>
							<div class="tabs">
								<button class="tab active" onclick="switchTab('area')">æŒ‰é¢ç§¯è®¡ä»·</button>
								<button class="tab" onclick="switchTab('fixed')">ä¸€æ¬¡æ€§ä»˜è´¹</button>
								<button class="tab" onclick="switchTab('free')">å…è´¹</button>
							</div>

							<div id="area-tab" class="tab-content active">
								<div class="form-group">
									<label>åŸºç¡€ä»·æ ¼ (å…ƒ/å¹³æ–¹å˜ç±³)</label>
									<input type="number" id="base-price-area" class="form-control" value="0.5" step="0.01" />
								</div>
								<div class="form-group">
									<label>é™„åŠ ä»·æ ¼ (å…ƒ)</label>
									<input type="number" id="extra-price-area" class="form-control" value="10" step="0.01" />
								</div>
								<p style="color: #5a6c7d; font-size: 14px; margin-top: 10px">è®¡ç®—å…¬å¼ï¼š(åŸºç¡€ä»·æ ¼ Ã— é¢ç§¯) + é™„åŠ ä»·æ ¼</p>
							</div>

							<div id="fixed-tab" class="tab-content">
								<div class="form-group">
									<label>åŸºç¡€ä»·æ ¼ (å…ƒ)</label>
									<input type="number" id="base-price-fixed" class="form-control" value="100" step="0.01" />
								</div>
								<div class="form-group">
									<label>é¢ç§¯ç³»æ•°</label>
									<input type="number" id="area-factor" class="form-control" value="0.1" step="0.01" />
								</div>
								<p style="color: #5a6c7d; font-size: 14px; margin-top: 10px">è®¡ç®—å…¬å¼ï¼šåŸºç¡€ä»·æ ¼ + (é¢ç§¯ç³»æ•° Ã— é¢ç§¯)</p>
							</div>

							<div id="free-tab" class="tab-content">
								<p style="color: #5a6c7d; font-size: 14px">æ­¤è§„åˆ™ä¸‹æ‰€æœ‰è®¢å•å…è´¹</p>
							</div>
						</div>

						<div class="form-section">
							<h3>æ¡ä»¶è§„åˆ™</h3>
							<div id="conditionsList">
								<!-- åŠ¨æ€ç”Ÿæˆçš„æ¡ä»¶è§„åˆ™ -->
							</div>
							<button class="btn btn-secondary" style="width: 100%; margin-top: 10px" onclick="addCondition()">+ æ·»åŠ æ¡ä»¶è§„åˆ™</button>
						</div>
					</div>
				</div>
			</main>
		</div>

		<!-- å›ºå®šåœ¨åº•éƒ¨çš„ä»·æ ¼æ˜¾ç¤º -->
		<div class="price-display-fixed">
			<div class="price-label">é¢„ä¼°ä»·æ ¼</div>
			<div class="price-value" id="finalPrice">Â¥0.00</div>
		</div>

		<!-- æ–°å»ºè§„åˆ™æ¨¡æ€æ¡† -->
		<div id="newRuleModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>æ–°å»ºè®¡ä»·è§„åˆ™</h3>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label>è§„åˆ™åç§°</label>
						<input type="text" id="newRuleName" class="form-control" placeholder="è¾“å…¥è§„åˆ™åç§°" />
					</div>
					<div class="form-group">
						<label>è®¡ä»·æ–¹å¼</label>
						<select id="newRuleType" class="form-control">
							<option value="area">æŒ‰é¢ç§¯è®¡ä»·</option>
							<option value="fixed">ä¸€æ¬¡æ€§ä»˜è´¹</option>
							<option value="free">å…è´¹</option>
						</select>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeModal('newRuleModal')">å–æ¶ˆ</button>
					<button class="btn btn-primary" onclick="createNewRule()">åˆ›å»º</button>
				</div>
			</div>
		</div>

		<!-- æ·»åŠ å·¥è‰ºæ¨¡æ€æ¡† -->
		<div id="addProcessModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>æ·»åŠ è‡ªå®šä¹‰å·¥è‰º</h3>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label>å·¥è‰ºåç§°</label>
						<input type="text" id="processName" class="form-control" placeholder="è¾“å…¥å·¥è‰ºåç§°" />
					</div>
					<div class="form-group">
						<label>è¾“å…¥ç±»å‹</label>
						<select id="processType" class="form-control" onchange="toggleProcessInput()">
							<option value="select">ä¸‹æ‹‰é€‰æ‹©</option>
							<option value="input">æ•°å€¼è¾“å…¥</option>
							<option value="color">é¢œè‰²é€‰æ‹©</option>
						</select>
					</div>
					<div class="form-group" id="processOptionsGroup">
						<label>é€‰é¡¹å€¼ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
						<textarea id="processOptions" class="form-control" rows="4" placeholder="é€‰é¡¹1&#10;é€‰é¡¹2&#10;é€‰é¡¹3"></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeModal('addProcessModal')">å–æ¶ˆ</button>
					<button class="btn btn-primary" onclick="addCustomProcess()">æ·»åŠ </button>
				</div>
			</div>
		</div>

		<style>
			/* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */

			/* æ–°å¢çš„å›ºå®šä»·æ ¼æ˜¾ç¤ºæ ·å¼ */
			.price-display-fixed {
				position: fixed;
				bottom: 0;
				right: 0;
				width: 300px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 20px;
				box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
				z-index: 1000;
				display: flex;
				justify-content: space-between;
				align-items: center;
				border-top-left-radius: 12px;
				animation: slideUp 0.3s ease-out;
			}

			.price-display-fixed .price-label {
				font-size: 16px;
				font-weight: 500;
				opacity: 0.9;
			}

			.price-display-fixed .price-value {
				font-size: 24px;
				font-weight: bold;
			}

			/* ä¸ºäº†é¿å…å†…å®¹è¢«å›ºå®šä»·æ ¼é®æŒ¡ï¼Œç»™ä¸»å†…å®¹æ·»åŠ åº•éƒ¨å†…è¾¹è· */
			.main-content {
				padding-bottom: 80px;
			}

			/* åŠ¨ç”»æ•ˆæœ */
			@keyframes slideUp {
				from {
					transform: translateY(100%);
					opacity: 0;
				}

				to {
					transform: translateY(0);
					opacity: 1;
				}
			}

			/* å“åº”å¼è°ƒæ•´ */
			@media (max-width: 768px) {
				.price-display-fixed {
					width: 100%;
					border-top-left-radius: 0;
				}
			}
		</style>
	</body>

	<script>
		// å…¨å±€å˜é‡
		// allRules å°†ä½œä¸ºå”¯ä¸€çš„æ•°æ®æºï¼Œå­˜å‚¨æ‰€æœ‰è§„åˆ™
		let allRules = {
			'default': {
				id: 'default',
				name: 'é»˜è®¤è§„åˆ™',
				type: 'area',
				basePrice: 0.5,
				extraPrice: 10,
				conditions: [],
			},
		};
		// currentRuleId åªå­˜å‚¨å½“å‰é€‰ä¸­è§„åˆ™çš„ID
		let currentRuleId = 'default';

		let customProcesses = [];
		let allProcesses = [];

		// åˆå§‹åŒ–
		document.addEventListener('DOMContentLoaded', function () {
			initializeProcesses();
			renderProcesses();
			renderRulesList(); // æ–°å¢ï¼šç»Ÿä¸€æ¸²æŸ“è§„åˆ™åˆ—è¡¨
			selectRule('default'); // åˆå§‹åŒ–æ—¶é€‰ä¸­é»˜è®¤è§„åˆ™
			renderConditions();
		});

		// åˆå§‹åŒ–å·¥è‰ºåˆ—è¡¨
		function initializeProcesses() {
			allProcesses = [
				{
					id: 'put_together',
					name: 'æ‹¼æ¿æ¬¾æ•°',
					type: 'input',
					unit: 'ä¸ª',
				},
				{
					id: 'delivery',
					name: 'å‡ºè´§æ–¹å¼',
					type: 'select',
					options: ['å•ç‰‡', 'æ‹¼æ¿'],
				},
				{
					id: 'copper_thick',
					name: 'å¤–å±‚é“œåš',
					type: 'input',
					unit: 'ç›å¸',
				},
				{
					id: 'soldermask_color',
					name: 'é˜»ç„Šé¢œè‰²',
					type: 'color',
					default: '#2E8B57',
				},
				{
					id: 'content_color',
					name: 'å­—ç¬¦é¢œè‰²',
					type: 'color',
					default: '#ffffff',
				},
				{
					id: 'solder_cover',
					name: 'é˜»ç„Šè¦†ç›–',
					type: 'select',
					options: ['è¿‡å­”ç›–æ²¹', 'è¿‡å­”å¼€çª—', 'è¿‡å­”å¡æ²¹', 'è¿‡å­”å¡æ ‘è„‚+è¿‡å­”ç”µé•€ç›–å¸½', 'è¿‡å­”å¡é“œæµ†+è¿‡å­”ç”µé•€ç›–å¸½'],
				},
				{
					id: 'solder_cover_type',
					name: 'ç„Šç›˜å–·é”¡',
					type: 'select',
					options: ['æœ‰é“…å–·é”¡', 'æ— é“…å–·é”¡', 'æ²‰é‡‘'],
				},
				{
					id: 'min_hole_diameter',
					name: 'æœ€å°å­”å¾„/å¤–å¾„',
					type: 'select',
					options: ['0.3mm(å¤–å¾„0.4/0.45)', '0.25mm(å¤–å¾„0.35/0.4)', '0.2mm(å¤–å¾„0.3/0.35)', '0.15mm(å¤–å¾„0.25/0.3)'],
				},
				{
					id: 'gold_finger_bevel',
					name: 'é‡‘(é”¡)æ‰‹æŒ‡æ–œè¾¹',
					type: 'select',
					options: ['ä¸éœ€è¦', 'éœ€è¦'],
				},
				{
					id: 'line_test',
					name: 'çº¿è·¯æµ‹è¯•',
					type: 'select',
					options: ['AOIå…¨æµ‹+é£é’ˆå…¨æµ‹'],
				},
			];
		}

		// æ¸²æŸ“å·¥è‰ºåˆ—è¡¨
		function renderProcesses() {
			const processList = document.getElementById('processList');
			processList.innerHTML = '';

			[...allProcesses, ...customProcesses].forEach((process) => {
				const processItem = document.createElement('div');
				processItem.className = 'process-item';
				processItem.innerHTML = `
            <div class="process-name">${process.name}</div>
            <div class="process-control">
                ${renderProcessControl(process)}
            </div>
            ${
				process.custom
					? `
                <div class="process-actions">
                    <button class="icon-btn" onclick="editProcess('${process.id}')">âœï¸</button>
                    <button class="icon-btn" onclick="deleteProcess('${process.id}')">ğŸ—‘ï¸</button>
                </div>
            `
					: ''
			}
        `;
				processList.appendChild(processItem);
			});
		}

		// æ¸²æŸ“å·¥è‰ºæ§ä»¶
		function renderProcessControl(process) {
			switch (process.type) {
				case 'select':
					return `<select id="process-${process.id}" class="form-control">
                ${process.options.map((opt) => `<option value="${opt}">${opt}</option>`).join('')}
            </select>`;
				case 'input':
					return `<div class="input-group">
                <input type="number" id="process-${process.id}" class="form-control" placeholder="è¾“å…¥æ•°å€¼">
                ${process.unit ? `<span class="unit">${process.unit}</span>` : ''}
            </div>`;
				case 'color':
					return `<div class="color-picker-wrapper">
                <input type="color" id="process-${process.id}" class="color-picker" value="${process.default || '#000000'}">
                <span>${process.default || '#000000'}</span>
            </div>`;
				default:
					return '';
			}
		}

		// æ·»åŠ æ¡ä»¶è§„åˆ™
		function addCondition() {
			const condition = {
				id: Date.now(),
				process: '',
				operator: '=',
				value: '',
				action: '+',
				amount: 0,
			};
			// é€šè¿‡ currentRuleId è·å–å½“å‰è§„åˆ™
			allRules[currentRuleId].conditions.push(condition);
			renderConditions();
		}

		// æ¸²æŸ“æ¡ä»¶è§„åˆ™
		function renderConditions() {
			const conditionsList = document.getElementById('conditionsList');
			conditionsList.innerHTML = '';

			const currentRule = allRules[currentRuleId];
			if (!currentRule || currentRule.conditions.length === 0) {
				conditionsList.innerHTML = '<p style="color: #5a6c7d; text-align: center;">æš‚æ— æ¡ä»¶è§„åˆ™</p>';
				return;
			}

			currentRule.conditions.forEach((condition) => {
				const conditionDiv = document.createElement('div');
				conditionDiv.className = 'condition-rule';
				conditionDiv.innerHTML = `
            <div class="condition-header">
                <span class="condition-title">æ¡ä»¶è§„åˆ™ #${condition.id}</span>
                <button class="icon-btn" onclick="removeCondition(${condition.id})">âŒ</button>
            </div>
            <div class="condition-body">
                <span>å¦‚æœ</span>
                <select class="condition-select" onchange="updateCondition(${condition.id}, 'process', this.value)">
                    <option value="">é€‰æ‹©å·¥è‰º</option>
                    ${[...allProcesses, ...customProcesses]
						.map((p) => `<option value="${p.id}" ${condition.process === p.id ? 'selected' : ''}>${p.name}</option>`)
						.join('')}
                </select>
                <select class="condition-select" onchange="updateCondition(${condition.id}, 'operator', this.value)">
                    <option value="=" ${condition.operator === '=' ? 'selected' : ''}>=</option>
                    <option value=">" ${condition.operator === '>' ? 'selected' : ''}>></option>
                    <option value="<" ${condition.operator === '<' ? 'selected' : ''}><</option>
                    <option value=">=" ${condition.operator === '>=' ? 'selected' : ''}>>=</option>
                    <option value="<=" ${condition.operator === '<=' ? 'selected' : ''}<=</option>
                </select>
                <input type="text" class="condition-input" placeholder="å€¼" value="${condition.value}" 
                       onchange="updateCondition(${condition.id}, 'value', this.value)">
                <span>åˆ™ä»·æ ¼</span>
                <select class="condition-select" onchange="updateCondition(${condition.id}, 'action', this.value)">
                    <option value="+" ${condition.action === '+' ? 'selected' : ''}>+</option>
                    <option value="-" ${condition.action === '-' ? 'selected' : ''}>-</option>
                    <option value="*" ${condition.action === '*' ? 'selected' : ''}>Ã—</option>
                    <option value="/" ${condition.action === '/' ? 'selected' : ''}>Ã·</option>
                </select>
                <input type="number" class="condition-input" placeholder="é‡‘é¢" value="${condition.amount}"
                       onchange="updateCondition(${condition.id}, 'amount', this.value)">
            </div>
        `;
				conditionsList.appendChild(conditionDiv);
			});
		}

		// æ›´æ–°æ¡ä»¶
		function updateCondition(id, field, value) {
			const condition = allRules[currentRuleId].conditions.find((c) => c.id === id);
			if (condition) {
				condition[field] = field === 'amount' ? parseFloat(value) || 0 : value;
			}
		}

		// åˆ é™¤æ¡ä»¶
		function removeCondition(id) {
			allRules[currentRuleId].conditions = allRules[currentRuleId].conditions.filter((c) => c.id !== id);
			renderConditions();
		}

		// åˆ‡æ¢æ ‡ç­¾é¡µ
		function switchTab(tab) {
			document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));

			event.target.classList.add('active');
			document.getElementById(`${tab}-tab`).classList.add('active');

			// æ›´æ–°å½“å‰è§„åˆ™çš„ç±»å‹
			allRules[currentRuleId].type = tab;
		}

		// è®¡ç®—ä»·æ ¼
		function calculatePrice() {
			const length = parseFloat(document.getElementById('length-input').value) || 0;
			const width = parseFloat(document.getElementById('width-input').value) || 0;
			const area = length * width;

			let price = 0;
			const currentRule = allRules[currentRuleId];

			switch (currentRule.type) {
				case 'area':
					const basePrice = parseFloat(document.getElementById('base-price-area').value) || 0;
					const extraPrice = parseFloat(document.getElementById('extra-price-area').value) || 0;
					price = basePrice * area + extraPrice;
					break;
				case 'fixed':
					const fixedBase = parseFloat(document.getElementById('base-price-fixed').value) || 0;
					const areaFactor = parseFloat(document.getElementById('area-factor').value) || 0;
					price = fixedBase + areaFactor * area;
					break;
				case 'free':
					price = 0;
					break;
			}

			// åº”ç”¨æ¡ä»¶è§„åˆ™
			currentRule.conditions.forEach((condition) => {
				const processValue = getProcessValue(condition.process);
				if (evaluateCondition(processValue, condition.operator, condition.value)) {
					switch (condition.action) {
						case '+':
							price += condition.amount;
							break;
						case '-':
							price -= condition.amount;
							break;
						case '*':
							price *= condition.amount;
							break;
						case '/':
							price /= condition.amount;
							break;
					}
				}
			});

			document.getElementById('finalPrice').textContent = `Â¥${price.toFixed(2)}`;
		}

		// è·å–å·¥è‰ºå€¼
		function getProcessValue(processId) {
			const element = document.getElementById(`process-${processId}`);
			return element ? element.value : '';
		}

		// è¯„ä¼°æ¡ä»¶
		function evaluateCondition(actual, operator, expected) {
			if (actual === undefined || actual === null || expected === '') return false;

			const a = parseFloat(actual) || actual;
			const e = parseFloat(expected) || expected;

			switch (operator) {
				case '=':
					return a == e;
				case '>':
					return a > e;
				case '<':
					return a < e;
				case '>=':
					return a >= e;
				case '<=':
					return a <= e;
				default:
					return false;
			}
		}

		// æ˜¾ç¤ºæ–°å»ºè§„åˆ™æ¨¡æ€æ¡†
		function showNewRuleModal() {
			document.getElementById('newRuleModal').classList.add('show');
		}

		// æ˜¾ç¤ºæ·»åŠ å·¥è‰ºæ¨¡æ€æ¡†
		function showAddProcessModal() {
			document.getElementById('addProcessModal').classList.add('show');
		}

		// å…³é—­æ¨¡æ€æ¡†
		function closeModal(modalId) {
			document.getElementById(modalId).classList.remove('show');
		}

		// åˆ›å»ºæ–°è§„åˆ™
		function createNewRule() {
			const name = document.getElementById('newRuleName').value;
			const type = document.getElementById('newRuleType').value;

			if (!name) {
				alert('è¯·è¾“å…¥è§„åˆ™åç§°');
				return;
			}

			const newRule = {
				id: Date.now().toString(),
				name: name,
				type: type,
				basePrice: 0.5,
				extraPrice: 10,
				conditions: [],
			};

			// ä¿å­˜åˆ°allRules
			allRules[newRule.id] = newRule;

			// é‡æ–°æ¸²æŸ“è§„åˆ™åˆ—è¡¨
			renderRulesList();

			// ç«‹å³åˆ‡æ¢åˆ°æ–°è§„åˆ™
			selectRule(newRule.id);

			closeModal('newRuleModal');
			document.getElementById('newRuleName').value = '';
		}

		// æ¸²æŸ“è§„åˆ™åˆ—è¡¨ (æ–°å¢å‡½æ•°ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†ä¾§è¾¹æ )
		function renderRulesList() {
			const rulesList = document.getElementById('rulesList');
			rulesList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨

			Object.values(allRules).forEach((rule) => {
				const ruleItem = document.createElement('div');
				ruleItem.className = 'rule-item';
				ruleItem.dataset.ruleId = rule.id;
				ruleItem.innerHTML = `
            <div class="rule-name">${rule.name}</div>
            <div class="rule-type">${rule.type === 'area' ? 'æŒ‰é¢ç§¯è®¡ä»·' : rule.type === 'fixed' ? 'ä¸€æ¬¡æ€§ä»˜è´¹' : 'å…è´¹'}</div>
        `;
				ruleItem.onclick = () => selectRule(rule.id);
				rulesList.appendChild(ruleItem);
			});
		}

		// é€‰æ‹©è§„åˆ™ (å·²ä¿®å¤)
		function selectRule(ruleId) {
			// æ£€æŸ¥è§„åˆ™æ˜¯å¦å­˜åœ¨
			if (!allRules[ruleId]) {
				console.error(`Rule with id ${ruleId} not found.`);
				return;
			}

			// æ›´æ–°å½“å‰è§„åˆ™ID
			currentRuleId = ruleId;
			const currentRule = allRules[currentRuleId];

			// æ›´æ–°UIé€‰ä¸­çŠ¶æ€
			document.querySelectorAll('.rule-item').forEach((item) => item.classList.remove('active'));
			const selectedItem = document.querySelector(`[data-rule-id="${ruleId}"]`);
			if (selectedItem) {
				selectedItem.classList.add('active');
			}

			// æ›´æ–°æ ‡ç­¾é¡µ
			document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));

			const activeTab = document.querySelector(`.tab[data-tab="${currentRule.type}"]`);
			if (activeTab) {
				activeTab.classList.add('active');
				document.getElementById(`${currentRule.type}-tab`).classList.add('active');
			}

			// é‡æ–°æ¸²æŸ“æ¡ä»¶
			renderConditions();
		}

		// æ·»åŠ è‡ªå®šä¹‰å·¥è‰º
		function addCustomProcess() {
			const name = document.getElementById('processName').value;
			const type = document.getElementById('processType').value;
			const options = document
				.getElementById('processOptions')
				.value.split('\n')
				.filter((o) => o.trim());

			if (!name) {
				alert('è¯·è¾“å…¥å·¥è‰ºåç§°');
				return;
			}

			if (type === 'select' && options.length === 0) {
				alert('è¯·æ·»åŠ é€‰é¡¹å€¼');
				return;
			}

			const process = {
				id: 'custom_' + Date.now(),
				name: name,
				type: type,
				options: options,
				custom: true,
			};

			customProcesses.push(process);
			renderProcesses();
			renderConditions();

			closeModal('addProcessModal');
			document.getElementById('processName').value = '';
			document.getElementById('processOptions').value = '';
		}

		// åˆ é™¤è‡ªå®šä¹‰å·¥è‰º
		function deleteProcess(processId) {
			if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå·¥è‰ºå—ï¼Ÿ')) {
				customProcesses = customProcesses.filter((p) => p.id !== processId);
				renderProcesses();
				renderConditions();
			}
		}

		// åˆ‡æ¢å·¥è‰ºè¾“å…¥ç±»å‹
		function toggleProcessInput() {
			const type = document.getElementById('processType').value;
			const optionsGroup = document.getElementById('processOptionsGroup');
			optionsGroup.style.display = type === 'select' ? 'block' : 'none';
		}

		// å¯¼å‡ºè§„åˆ™
		function exportRules() {
			const rules = {
				currentRuleId: currentRuleId,
				allRules: allRules,
				customProcesses: customProcesses,
				timestamp: new Date().toISOString(),
			};

			const blob = new Blob([JSON.stringify(rules, null, 2)], {
				type: 'application/json',
			});
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `pcb-pricing-rules-${Date.now()}.json`;
			a.click();
			URL.revokeObjectURL(url);
		}

		// å¯¼å…¥è§„åˆ™
		function importRules() {
			const input = document.createElement('input');
			input.type = 'file';
			input.accept = '.json';
			input.onchange = function (e) {
				const file = e.target.files[0];
				if (!file) return;

				const reader = new FileReader();
				reader.onload = function (event) {
					try {
						const data = JSON.parse(event.target.result);

						// å¯¼å…¥æ‰€æœ‰è§„åˆ™
						if (data.allRules) {
							allRules = data.allRules;
							renderRulesList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
						}

						// å¯¼å…¥è‡ªå®šä¹‰å·¥è‰º
						if (data.customProcesses) {
							customProcesses = data.customProcesses;
							renderProcesses();
						}

						// é€‰ä¸­å¯¼å…¥æ—¶è®°å½•çš„å½“å‰è§„åˆ™
						if (data.currentRuleId && allRules[data.currentRuleId]) {
							selectRule(data.currentRuleId);
						} else if (Object.keys(allRules).length > 0) {
							// å¦‚æœæ²¡æœ‰è®°å½•æˆ–è®°å½•æ— æ•ˆï¼Œåˆ™é€‰ä¸­ç¬¬ä¸€ä¸ªè§„åˆ™
							selectRule(Object.keys(allRules)[0]);
						}

						alert('è§„åˆ™å¯¼å…¥æˆåŠŸ');
					} catch (error) {
						console.error('å¯¼å…¥é”™è¯¯:', error);
						alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
					}
				};
				reader.readAsText(file);
				// æ¸…ç©ºinputå€¼ï¼Œç¡®ä¿å¯ä»¥é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
				input.value = '';
			};
			input.click();
		}

		// PCBè¯†åˆ«å‡½æ•°
		async function GetPcbInfomation() {
			try {
				const ids = await eda.pcb_PrimitivePolyline.getAllPrimitiveId(null, 11);
				eda.pcb_SelectControl.doSelectPrimitives(ids);
				let PCB_Infomation = await eda.pcb_SelectControl.getSelectedPrimitives();
				PCB_Infomation = PCB_Infomation[0];
				let width = PCB_Infomation.width * 0.254;
				let height = PCB_Infomation.height * 0.254;
				const All_Layers = await eda.pcb_Layer.getAllLayers();

				document.getElementById('width-input').value = Math.round((width / 10) * 100) / 100;
				document.getElementById('length-input').value = Math.round((height / 10) * 100) / 100;
				document.getElementById('layer-input').value = calcLayers(All_Layers);
				eda.sys_Message.showToastMessage('è¯†åˆ«æˆåŠŸ', 'success', 2);
				// è‡ªåŠ¨è®¡ç®—ä»·æ ¼
				calculatePrice();
			} catch (error) {
				eda.sys_Message.showToastMessage('æœªè¯†åˆ«åˆ°æ¿æ¡†æˆ–æ¿æ¡†è¿‡å¤šï¼Œè¯·æ‰‹åŠ¨æ¡†é€‰å¹¶é‡è¯•', 'error', 2);
			}
		}

		// è·å–PCBå±‚æ•°
		function calcLayers(layers) {
			let count = 0;
			const ids = [
				1,
				2,
				...Array.from(
					{
						length: 32,
					},
					(_, i) => i + 15,
				),
			];
			for (const layer of layers) {
				const id = parseInt(layer.id);
				if (ids.includes(id) && layer.layerStatus === 1) {
					count++;
				}
			}
			return count;
		}

		// ç›‘å¬é¢œè‰²é€‰æ‹©å™¨å˜åŒ–
		document.addEventListener('change', function (e) {
			if (e.target.type === 'color') {
				const span = e.target.nextElementSibling;
				if (span) {
					span.textContent = e.target.value;
				}
			}
		});
	</script>
</html>
