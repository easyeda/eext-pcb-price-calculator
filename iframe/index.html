<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>PCB 动态计价工具</title>
		<style>
			/* --- 全局与布局样式 --- */
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
				margin: 0;
				padding: 15px;
				background-color: #f4f7f6;
				color: #333;
				height: 100vh;
				box-sizing: border-box;
			}

			#app {
				display: flex;
				gap: 20px;
				height: 100%;
			}

			.section {
				background-color: #fff;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
				flex: 1; /* 三个部分平均分配空间 */
				display: flex;
				flex-direction: column;
			}

			.section h2 {
				margin-top: 0;
				font-size: 1.2em;
				color: #0056b3;
				border-bottom: 2px solid #e9ecef;
				padding-bottom: 10px;
				margin-bottom: 20px;
			}

			/* --- 表单与控件样式 --- */
			.form-group {
				margin-bottom: 15px;
			}

			.form-group label {
				display: block;
				margin-bottom: 5px;
				font-weight: 500;
			}

			.form-group input,
			.form-group select {
				width: 100%;
				padding: 8px 10px;
				border: 1px solid #ccc;
				border-radius: 4px;
				box-sizing: border-box;
			}

			/* --- 按钮样式 --- */
			.btn-primary,
			.btn-success,
			.btn-danger,
			.btn-secondary,
			.btn-warning {
				padding: 10px 15px;
				border: none;
				border-radius: 4px;
				color: white;
				cursor: pointer;
				font-size: 14px;
				transition: background-color 0.2s;
				margin-right: 5px; /* 为按钮组增加间距 */
			}

			.btn-primary {
				background-color: #007bff;
			}
			.btn-primary:hover {
				background-color: #0056b3;
			}

			.btn-success {
				background-color: #28a745;
			}
			.btn-success:hover {
				background-color: #218838;
			}

			.btn-danger {
				background-color: #dc3545;
			}
			.btn-danger:hover {
				background-color: #c82333;
			}

			.btn-secondary {
				background-color: #6c757d;
			}
			.btn-secondary:hover {
				background-color: #5a6268;
			}

			.btn-warning {
				background-color: #ffc107;
				color: #212529;
			}
			.btn-warning:hover {
				background-color: #e0a800;
			}

			/* --- 特定元素样式 --- */
			#statusMessage {
				margin-top: 15px;
				font-size: 0.9em;
			}

			#finalPrice {
				margin-top: 20px;
				padding: 15px;
				background-color: #e9ecef;
				border-radius: 4px;
				font-size: 0.9em;
				line-height: 1.6;
			}

			/* --- 配置对话框样式 --- */
			#configDialog {
				border: 1px solid #ccc;
				border-radius: 8px;
				padding: 0;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
				width: 600px;
				max-width: 90vw;
			}

			#configDialog::backdrop {
				background-color: rgba(0, 0, 0, 0.5);
			}

			.dialog-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 15px 20px;
				background-color: #007bff;
				color: white;
				border-top-left-radius: 8px;
				border-top-right-radius: 8px;
			}

			.dialog-header h3 {
				margin: 0;
			}

			.close-btn {
				background: none;
				border: none;
				color: white;
				font-size: 1.5em;
				cursor: pointer;
				line-height: 1;
			}

			.dialog-body {
				padding: 20px;
				max-height: 70vh;
				overflow-y: auto;
			}

			.dialog-body h3 {
				border-bottom: 1px solid #eee;
				padding-bottom: 10px;
				margin-top: 0;
			}

			#conditionsList {
				margin-top: 20px;
			}

			.condition-item {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 10px;
				background-color: #f8f9fa;
				border: 1px solid #dee2e6;
				border-radius: 4px;
				margin-bottom: 10px;
			}

			.rule-management {
				margin-top: 30px;
				padding-top: 20px;
				border-top: 1px solid #ccc;
			}

			/* --- 齿轮按钮样式 --- */
			#openConfigBtn {
				position: absolute;
				top: 20px;
				right: 20px;
				background: none;
				border: none;
				font-size: 1.5em;
				cursor: pointer;
				color: #6c757d;
			}
			#openConfigBtn:hover {
				color: #0056b3;
			}

			/* --- 新增：规则管理区域样式 --- */
			#savedRulesContainer {
				display: flex;
				align-items: center;
				gap: 10px;
			}
			#savedRulesSelect {
				flex-grow: 1;
			}
			.rule-management-buttons {
				margin-top: 10px;
			}
		</style>
	</head>
	<body>
		<div id="app">
			<!-- 第一部分：从EDA获取尺寸 -->
			<div class="section">
				<h2>1. 获取PCB尺寸</h2>
				<p>请先框选需要计价的PCB，然后点击下方按钮自动获取宽度和高度。</p>
				<button id="getDimensionsBtn" class="btn-primary">获取选中图元尺寸</button>
				<div id="statusMessage"></div>
			</div>

			<!-- 第二部分：基础信息和动态计价 -->
			<div class="section" style="position: relative">
				<h2>2. 配置计价参数</h2>
				<button id="openConfigBtn" title="高级配置">⚙️</button>

				<div class="form-group">
					<label for="width">宽度:</label>
					<input type="number" id="width" step="0.01" placeholder="单位: mm" />
				</div>
				<div class="form-group">
					<label for="height">高度:</label>
					<input type="number" id="height" step="0.01" placeholder="单位: mm" />
				</div>
				<div class="form-group">
					<label for="basePrice">基础单价(元):</label>
					<input type="number" id="basePrice" value="0.01" step="0.001" placeholder="单位: 元/mm²" />
				</div>

				<button id="calculateBtn" class="btn-primary" style="margin-top: auto">计算最终价格</button>
			</div>

			<!-- 第三部分：价格结果 -->
			<div class="section">
				<h2>3. 计价结果</h2>
				<div id="finalPrice" style="color: #888">请先配置参数并点击计算。</div>
			</div>
		</div>

		<!-- 配置对话框 -->
		<dialog id="configDialog">
			<div class="dialog-header">
				<h3>高级配置</h3>
				<button class="close-btn" id="closeDialogBtn">&times;</button>
			</div>
			<div class="dialog-body">
				<!-- 动态计价条件 -->
				<h3>动态计价条件</h3>
				<div class="form-group">
					<label for="conditionName">条件名称:</label>
					<input type="text" id="conditionName" placeholder="例如: FR-4板材" />
				</div>
				<div class="form-group">
					<label for="conditionType">计价方式:</label>
					<select id="conditionType">
						<option value="area">面积类型 (增加单价)</option>
						<option value="fixed">一次性类型 (固定费用)</option>
					</select>
				</div>
				<div class="form-group">
					<label for="conditionAmount">金额:</label>
					<input type="number" id="conditionAmount" step="0.01" placeholder="单价(元/mm²) 或 固定费用(元)" />
				</div>
				<button id="addConditionBtn" class="btn-success">添加计价条件</button>
				<div id="conditionsList"></div>

				<!-- 计价规则管理 -->
				<div class="rule-management">
					<h3>计价规则管理</h3>
					<div class="form-group">
						<label for="ruleName">当前规则名称:</label>
						<input type="text" id="ruleName" placeholder="例如: 标准双面板打样" />
					</div>
					<div class="form-group">
						<label></label>
						<!-- 修改：保存按钮 -->
						<button id="saveRuleBtn" class="btn-secondary">保存当前规则</button>
					</div>

					<!-- 新增：规则加载与管理区域 -->
					<div class="form-group">
						<label>已保存的规则:</label>
						<div id="savedRulesContainer">
							<select id="savedRulesSelect">
								<option value="">-- 请选择要加载的规则 --</option>
							</select>
							<button id="loadRuleBtn" class="btn-primary">加载</button>
							<button id="deleteRuleBtn" class="btn-danger">删除</button>
						</div>
					</div>
					<div class="rule-management-buttons">
						<button id="refreshRulesBtn" class="btn-secondary">刷新列表</button>
						<button id="clearAllRulesBtn" class="btn-warning">清空所有规则</button>
					</div>
				</div>
			</div>
		</dialog>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				// --- DOM 元素引用 ---
				const getDimensionsBtn = document.getElementById('getDimensionsBtn');
				const widthInput = document.getElementById('width');
				const heightInput = document.getElementById('height');
				const basePriceInput = document.getElementById('basePrice');
				const calculateBtn = document.getElementById('calculateBtn');
				const finalPriceDiv = document.getElementById('finalPrice');
				const statusMessage = document.getElementById('statusMessage');

				// 对话框相关
				const configDialog = document.getElementById('configDialog');
				const openConfigBtn = document.getElementById('openConfigBtn');
				const closeDialogBtn = document.getElementById('closeDialogBtn');

				// 对话框内元素
				const addConditionBtn = document.getElementById('addConditionBtn');
				const conditionsListDiv = document.getElementById('conditionsList');
				const ruleNameInput = document.getElementById('ruleName');

				// --- 新增/修改的DOM元素 ---
				const saveRuleBtn = document.getElementById('saveRuleBtn'); // 原 exportRuleBtn
				const savedRulesSelect = document.getElementById('savedRulesSelect');
				const loadRuleBtn = document.getElementById('loadRuleBtn');
				const deleteRuleBtn = document.getElementById('deleteRuleBtn');
				const refreshRulesBtn = document.getElementById('refreshRulesBtn');
				const clearAllRulesBtn = document.getElementById('clearAllRulesBtn');

				// --- 数据存储 ---
				let priceConditions = []; // 存储动态计价条件的数组

				// --- 事件监听器 ---

				// 1. 获取尺寸按钮的点击事件 (无变化)
				getDimensionsBtn.addEventListener('click', function () {
					statusMessage.textContent = '正在尝试从EDA获取尺寸...';
					statusMessage.style.color = '#007bff';

					// 调用EDA的图元类获取板框的长和宽
					const primitivesPromise = eda.pcb_SelectControl.getSelectedPrimitives();

					primitivesPromise
						.then((selectedArray) => {
							if (selectedArray && selectedArray.length > 0) {
								const firstPrimitive = selectedArray[0];
								const width = firstPrimitive.width * 0.254;
								const height = firstPrimitive.height * 0.254;

								widthInput.value = width.toFixed(2);
								heightInput.value = height.toFixed(2);

								statusMessage.textContent = `成功获取尺寸: ${width.toFixed(2)} mm x ${height.toFixed(2)} mm`;
								statusMessage.style.color = 'green';
							} else {
								statusMessage.textContent = '没有选中的图元。请在EDA中选中PCB板框后重试。';
								statusMessage.style.color = 'orange';
							}
						})
						.catch((error) => {
							statusMessage.textContent = '获取图元时发生错误，请查看控制台。';
							statusMessage.style.color = 'red';
							console.error('获取图元时发生错误:', error);
						});
				});

				// 2. 计算最终价格按钮的点击事件 (无变化)
				calculateBtn.addEventListener('click', function () {
					const width = parseFloat(widthInput.value);
					const height = parseFloat(heightInput.value);
					const basePrice = parseFloat(basePriceInput.value);

					if (isNaN(width) || isNaN(height) || isNaN(basePrice)) {
						finalPriceDiv.innerHTML = '<span style="color: red;">请填写有效的宽度、高度和基础单价！</span>';
						return;
					}

					const area = width * height;
					let currentUnitPrice = basePrice;
					let fixedCosts = 0;

					priceConditions.forEach((condition) => {
						if (condition.type === 'area') {
							currentUnitPrice += condition.amount;
						} else if (condition.type === 'fixed') {
							fixedCosts += condition.amount;
						}
					});

					const areaCost = area * currentUnitPrice;
					const totalCost = areaCost + fixedCosts;

					finalPriceDiv.innerHTML = `
						<div>PCB 面积: <strong>${area.toFixed(2)} mm²</strong></div>
						<div>最终单价: <strong>${currentUnitPrice.toFixed(3)} 元/mm²</strong></div>
						<div>面积费用: <strong>${areaCost.toFixed(2)} 元</strong></div>
						<div>固定费用: <strong>${fixedCosts.toFixed(2)} 元</strong></div>
						<hr style="margin: 10px 0; border: none; border-top: 1px solid #ccc;">
						<div>最终总价: <span style="color: #dc3545; font-size: 1.2em; font-weight: bold;">${totalCost.toFixed(2)} 元</span></div>
					`;
				});

				// --- 对话框控制 ---
				openConfigBtn.addEventListener('click', () => {
					configDialog.showModal();
					refreshRulesList(); // 每次打开对话框时刷新规则列表
				});
				closeDialogBtn.addEventListener('click', () => configDialog.close());

				// 3. 添加计价条件按钮的点击事件 (无变化)
				addConditionBtn.addEventListener('click', function () {
					const name = document.getElementById('conditionName').value;
					const type = document.getElementById('conditionType').value;
					const amount = parseFloat(document.getElementById('conditionAmount').value);

					if (!name || isNaN(amount)) {
						alert('请填写完整的条件名称和金额！');
						return;
					}

					const newCondition = { name, type, amount };
					priceConditions.push(newCondition);

					// 清空输入框
					document.getElementById('conditionName').value = '';
					document.getElementById('conditionAmount').value = '';

					renderConditions();
				});

				// --- 修改的核心业务逻辑 ---

				// 4. 保存规则按钮的点击事件 (原导出)
				// 修改: 移除 async/await，改为同步调用
				saveRuleBtn.addEventListener('click', function () {
					const ruleName = ruleNameInput.value.trim();
					if (!ruleName) {
						alert('请先输入规则名称！');
						return;
					}
					const basePrice = parseFloat(basePriceInput.value);
					if (isNaN(basePrice)) {
						statusMessage.textContent = '保存失败：请先设置有效的基础单价。';
						statusMessage.style.color = 'red';
						return;
					}

					const ruleData = {
						ruleName: ruleName,
						basePrice: basePrice,
						conditions: priceConditions,
						exportDate: new Date().toLocaleString('zh-CN'),
					};

					try {
						// 修改: 直接调用函数，不使用 await
						const success = eda.sys_Storage.setExtensionUserConfig(ruleName, ruleData);
						if (success) {
							statusMessage.textContent = `规则 "${ruleName}" 已成功保存！`;
							statusMessage.style.color = 'green';
							refreshRulesList(); // 保存后刷新列表
						} else {
							throw new Error('保存操作返回失败');
						}
					} catch (error) {
						statusMessage.textContent = `保存失败: ${error.message}`;
						statusMessage.style.color = 'red';
						console.error('保存规则失败:', error);
					}
				});

				// 5. 加载规则按钮的点击事件
				// 修改: 移除 async/await 和 .then()，改为同步调用
				loadRuleBtn.addEventListener('click', function () {
					const selectedRuleName = savedRulesSelect.value;
					if (!selectedRuleName) {
						alert('请先从下拉框中选择一个规则！');
						return;
					}

					try {
						// 修改: 直接调用函数，不使用 .then()
						const ruleData = eda.sys_Storage.getExtensionUserConfig(selectedRuleName);
						if (ruleData) {
							// 将数据应用到界面
							ruleNameInput.value = ruleData.ruleName || '';
							basePriceInput.value = ruleData.basePrice;
							priceConditions = ruleData.conditions || [];
							renderConditions();

							statusMessage.textContent = `成功加载规则 "${selectedRuleName}"！`;
							statusMessage.style.color = 'green';
						} else {
							statusMessage.textContent = `加载失败：找不到规则 "${selectedRuleName}"`;
							statusMessage.style.color = 'red';
						}
					} catch (error) {
						statusMessage.textContent = `加载失败: ${error.message}`;
						statusMessage.style.color = 'red';
						console.error('加载规则失败:', error);
					}
				});

				// 6. 删除规则按钮的点击事件
				// 修改: 移除 async/await，改为同步调用
				deleteRuleBtn.addEventListener('click', function () {
					const selectedRuleName = savedRulesSelect.value;
					if (!selectedRuleName) {
						alert('请先从下拉框中选择一个要删除的规则！');
						return;
					}

					if (!confirm(`确定要删除规则 "${selectedRuleName}" 吗？此操作不可恢复。`)) {
						return;
					}

					try {
						// 修改: 直接调用函数，不使用 await
						const success = eda.sys_Storage.deleteExtensionUserConfig(selectedRuleName);
						if (success) {
							statusMessage.textContent = `规则 "${selectedRuleName}" 已删除。`;
							statusMessage.style.color = 'orange';
							refreshRulesList(); // 删除后刷新列表
						} else {
							throw new Error('删除操作返回失败');
						}
					} catch (error) {
						statusMessage.textContent = `删除失败: ${error.message}`;
						statusMessage.style.color = 'red';
						console.error('删除规则失败:', error);
					}
				});

				// 7. 清空所有规则按钮的点击事件
				// 修改: 移除 async/await，改为同步调用
				clearAllRulesBtn.addEventListener('click', function () {
					if (!confirm('确定要清空所有已保存的计价规则吗？此操作不可恢复！')) {
						return;
					}

					try {
						// 修改: 直接调用函数，不使用 await
						const success = eda.sys_Storage.clearExtensionAllUserConfigs();
						if (success) {
							statusMessage.textContent = '所有计价规则已清空。';
							statusMessage.style.color = 'orange';
							refreshRulesList(); // 清空后刷新列表
						} else {
							throw new Error('清空操作返回失败');
						}
					} catch (error) {
						statusMessage.textContent = `清空失败: ${error.message}`;
						statusMessage.style.color = 'red';
						console.error('清空规则失败:', error);
					}
				});

				// 8. 刷新列表按钮的点击事件
				refreshRulesBtn.addEventListener('click', refreshRulesList);

				// --- 辅助函数 ---

				// 渲染计价条件列表 (在对话框内)
				function renderConditions() {
					conditionsListDiv.innerHTML = '';
					if (priceConditions.length === 0) {
						conditionsListDiv.innerHTML = '<p>暂无计价条件。</p>';
						return;
					}

					priceConditions.forEach((condition, index) => {
						const conditionItem = document.createElement('div');
						conditionItem.className = 'condition-item';

						const info = document.createElement('div');
						info.className = 'condition-info';
						const typeText = condition.type === 'area' ? ' (面积类型)' : ' (一次性类型)';
						info.innerHTML = `<strong>${condition.name}</strong>: ${condition.amount} 元${condition.type === 'area' ? '/mm²' : ''}${typeText}`;

						const deleteButton = document.createElement('button');
						deleteButton.className = 'btn-danger';
						deleteButton.textContent = '删除';
						deleteButton.addEventListener('click', function () {
							priceConditions.splice(index, 1);
							renderConditions();
						});

						conditionItem.appendChild(info);
						conditionItem.appendChild(deleteButton);
						conditionsListDiv.appendChild(conditionItem);
					});
				}

				// --- 修改的核心辅助函数 ---

				/**
				 * 从存储中获取所有规则并刷新下拉框
				 * 修改: 移除 async/await，改为同步调用
				 */
				function refreshRulesList() {
					try {
						// 修改: 直接调用函数，不使用 await
						const allRules = eda.sys_Storage.getExtensionAllUserConfigs();
						// 清空现有选项
						savedRulesSelect.innerHTML = '<option value="">-- 请选择要加载的规则 --</option>';

						// 按名称排序
						const sortedRuleNames = Object.keys(allRules).sort();

						if (sortedRuleNames.length === 0) {
							savedRulesSelect.innerHTML = '<option value="">-- 暂无已保存的规则 --</option>';
						} else {
							sortedRuleNames.forEach((ruleName) => {
								const option = document.createElement('option');
								option.value = ruleName;
								option.textContent = ruleName;
								savedRulesSelect.appendChild(option);
							});
						}
					} catch (error) {
						console.error('刷新规则列表失败:', error);
						statusMessage.textContent = '刷新规则列表失败，请查看控制台。';
						statusMessage.style.color = 'red';
					}
				}

				// --- 初始化 ---
				renderConditions();
				// 页面加载时不需要立即刷新列表，在打开对话框时刷新即可
			});
		</script>
	</body>
</html>
