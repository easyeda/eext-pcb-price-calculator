<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
		<link rel="stylesheet" href="/iframe/style.css" />
		<title>PCB离线计价工具</title>
	</head>
	<body>
		<div class="container">
			<!-- 侧边栏 -->
			<aside class="sidebar">
				<h3>计价规则</h3>
				<div id="rulesList">
					<div class="rule-item active" data-rule-id="default">
						<div class="rule-name">默认规则</div>
						<div class="rule-type">按面积计价</div>
					</div>
				</div>
				<button class="btn btn-secondary" style="width: 100%; margin-top: 20px" onclick="showNewRuleModal()">+ 新建规则</button>
			</aside>

			<!-- 主内容区 -->
			<main class="main-content">
				<!-- 工具栏 -->
				<div class="toolbar">
					<div class="toolbar-left">
						<button class="btn btn-primary" onclick="GetPcbInfomation()">📐 识别PCB信息</button>
						<button class="btn btn-secondary" onclick="calculatePrice()">💰 计算价格</button>
					</div>
					<div class="toolbar-right">
						<button class="btn btn-secondary" onclick="exportRules()">📤 导出规则</button>
						<button class="btn btn-secondary" onclick="importRules()">📥 导入规则</button>
					</div>
				</div>

				<!-- 内容区域 -->
				<div class="content-area">
					<!-- 左侧面板 - PCB参数 -->
					<div class="left-panel">
						<div class="form-section">
							<h3>基本信息</h3>

							<div class="form-group">
								<label for="board-type">板材类别</label>
								<select id="board-type" class="form-control">
									<option value="fpc">FPC软板</option>
									<option value="fr4" selected>FR-4</option>
									<option value="aluminum">铝基板</option>
									<option value="copper">铜基板</option>
									<option value="rogers">罗杰斯高频板</option>
									<option value="ptfe">铁氟龙高频板</option>
								</select>
							</div>

							<div class="form-group">
								<label>板子尺寸</label>
								<div class="input-group">
									<input type="number" id="length-input" class="form-control" placeholder="长" />
									<span class="unit">CM</span>
									<input type="number" id="width-input" class="form-control" placeholder="宽" />
									<span class="unit">CM</span>
								</div>
							</div>

							<div class="form-group">
								<label>板子层数</label>
								<div class="input-group">
									<input type="number" id="layer-input" class="form-control" />
									<span class="unit">层</span>
								</div>
							</div>

							<div class="form-group">
								<label for="product-type">产品类型</label>
								<select id="product-type" class="form-control">
									<option value="others">工业/消费/其他类电子产品</option>
									<option value="aviation">航空</option>
									<option value="help">医疗</option>
								</select>
							</div>

							<div class="form-group">
								<label>确认生产稿</label>
								<div class="input-group">
									<input type="number" id="verify-group" class="form-control" placeholder="不需要则放空" />
									<span class="unit">次</span>
								</div>
							</div>
						</div>

						<div class="form-section">
							<h3>PCB工艺</h3>
							<div id="processList">
								<!-- 动态生成的工艺项 -->
							</div>
							<button class="btn btn-secondary" style="width: 100%; margin-top: 10px" onclick="showAddProcessModal()">
								+ 添加自定义工艺
							</button>
						</div>
					</div>

					<!-- 右侧面板 - 计价规则 -->
					<div class="right-panel">
						<div class="form-section">
							<h3>计价方式</h3>
							<div class="tabs">
								<button class="tab active" onclick="switchTab('area')">按面积计价</button>
								<button class="tab" onclick="switchTab('fixed')">一次性付费</button>
								<button class="tab" onclick="switchTab('free')">免费</button>
							</div>

							<div id="area-tab" class="tab-content active">
								<div class="form-group">
									<label>基础价格 (元/平方厘米)</label>
									<input type="number" id="base-price-area" class="form-control" value="0.5" step="0.01" />
								</div>
								<div class="form-group">
									<label>附加价格 (元)</label>
									<input type="number" id="extra-price-area" class="form-control" value="10" step="0.01" />
								</div>
								<p style="color: #5a6c7d; font-size: 14px; margin-top: 10px">计算公式：(基础价格 × 面积) + 附加价格</p>
							</div>

							<div id="fixed-tab" class="tab-content">
								<div class="form-group">
									<label>基础价格 (元)</label>
									<input type="number" id="base-price-fixed" class="form-control" value="100" step="0.01" />
								</div>
								<div class="form-group">
									<label>面积系数</label>
									<input type="number" id="area-factor" class="form-control" value="0.1" step="0.01" />
								</div>
								<p style="color: #5a6c7d; font-size: 14px; margin-top: 10px">计算公式：基础价格 + (面积系数 × 面积)</p>
							</div>

							<div id="free-tab" class="tab-content">
								<p style="color: #5a6c7d; font-size: 14px">此规则下所有订单免费</p>
							</div>
						</div>

						<div class="form-section">
							<h3>条件规则</h3>
							<div id="conditionsList">
								<!-- 动态生成的条件规则 -->
							</div>
							<button class="btn btn-secondary" style="width: 100%; margin-top: 10px" onclick="addCondition()">+ 添加条件规则</button>
						</div>
					</div>
				</div>
			</main>
		</div>

		<!-- 固定在底部的价格显示 -->
		<div class="price-display-fixed">
			<div class="price-label">预估价格</div>
			<div class="price-value" id="finalPrice">¥0.00</div>
		</div>

		<!-- 新建规则模态框 -->
		<div id="newRuleModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>新建计价规则</h3>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label>规则名称</label>
						<input type="text" id="newRuleName" class="form-control" placeholder="输入规则名称" />
					</div>
					<div class="form-group">
						<label>计价方式</label>
						<select id="newRuleType" class="form-control">
							<option value="area">按面积计价</option>
							<option value="fixed">一次性付费</option>
							<option value="free">免费</option>
						</select>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeModal('newRuleModal')">取消</button>
					<button class="btn btn-primary" onclick="createNewRule()">创建</button>
				</div>
			</div>
		</div>

		<!-- 添加工艺模态框 -->
		<div id="addProcessModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>添加自定义工艺</h3>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label>工艺名称</label>
						<input type="text" id="processName" class="form-control" placeholder="输入工艺名称" />
					</div>
					<div class="form-group">
						<label>输入类型</label>
						<select id="processType" class="form-control" onchange="toggleProcessInput()">
							<option value="select">下拉选择</option>
							<option value="input">数值输入</option>
							<option value="color">颜色选择</option>
						</select>
					</div>
					<div class="form-group" id="processOptionsGroup">
						<label>选项值（每行一个）</label>
						<textarea id="processOptions" class="form-control" rows="4" placeholder="选项1&#10;选项2&#10;选项3"></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeModal('addProcessModal')">取消</button>
					<button class="btn btn-primary" onclick="addCustomProcess()">添加</button>
				</div>
			</div>
		</div>

		<!-- 编辑工艺模态框 -->
		<div id="editProcessModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>编辑自定义工艺</h3>
				</div>
				<div class="modal-body">
					<input type="hidden" id="editProcessId" />
					<div class="form-group">
						<label>工艺名称</label>
						<input type="text" id="editProcessName" class="form-control" placeholder="输入工艺名称" />
					</div>
					<div class="form-group">
						<label>输入类型</label>
						<select id="editProcessType" class="form-control" onchange="toggleEditProcessInput()">
							<option value="select">下拉选择</option>
							<option value="input">数值输入</option>
							<option value="color">颜色选择</option>
						</select>
					</div>
					<div class="form-group" id="editProcessOptionsGroup" style="display: none">
						<label>选项值（每行一个）</label>
						<textarea id="editProcessOptions" class="form-control" rows="4" placeholder="选项1&#10;选项2&#10;选项3"></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeModal('editProcessModal')">取消</button>
					<button class="btn btn-primary" onclick="saveEditProcess()">保存</button>
				</div>
			</div>
		</div>
	</body>

	<script>
				// 全局变量
				// allRules 将作为唯一的数据源，存储所有规则
				let allRules = {
					'default': {
						id: 'default',
						name: '默认规则',
						type: 'area',
						basePrice: 0.5,
						extraPrice: 10,
						conditions: [],
						customProcesses: [], // 每个规则都有自己的自定义工艺
					},
				};
				// currentRuleId 只存储当前选中规则的ID
				let currentRuleId = 'default';

				let allProcesses = [];

				// 初始化
				document.addEventListener('DOMContentLoaded', function () {
					initializeProcesses();
					renderProcesses();
					renderRulesList(); // 新增：统一渲染规则列表
					selectRule('default'); // 初始化时选中默认规则
					renderConditions();
				});

				// 初始化工艺列表
				function initializeProcesses() {
					allProcesses = [
						{
							id: 'put_together',
							name: '拼板款数',
							type: 'input',
							unit: '个',
						},
						{
							id: 'delivery',
							name: '出货方式',
							type: 'select',
							options: ['单片', '拼板'],
						},
						{
							id: 'copper_thick',
							name: '外层铜厚',
							type: 'input',
							unit: '盎司',
						},
						{
							id: 'soldermask_color',
							name: '阻焊颜色',
							type: 'color',
							default: '#2E8B57',
						},
						{
							id: 'content_color',
							name: '字符颜色',
							type: 'color',
							default: '#ffffff',
						},
						{
							id: 'solder_cover',
							name: '阻焊覆盖',
							type: 'select',
							options: ['过孔盖油', '过孔开窗', '过孔塞油', '过孔塞树脂+过孔电镀盖帽', '过孔塞铜浆+过孔电镀盖帽'],
						},
						{
							id: 'solder_cover_type',
							name: '焊盘喷锡',
							type: 'select',
							options: ['有铅喷锡', '无铅喷锡', '沉金'],
						},
						{
							id: 'min_hole_diameter',
							name: '最小孔径/外径',
							type: 'select',
							options: ['0.3mm(外径0.4/0.45)', '0.25mm(外径0.35/0.4)', '0.2mm(外径0.3/0.35)', '0.15mm(外径0.25/0.3)'],
						},
						{
							id: 'gold_finger_bevel',
							name: '金(锡)手指斜边',
							type: 'select',
							options: ['不需要', '需要'],
						},
						{
							id: 'line_test',
							name: '线路测试',
							type: 'select',
							options: ['AOI全测+飞针全测'],
						},
					];
				}

				// 渲染工艺列表
				function renderProcesses() {
					const processList = document.getElementById('processList');
					processList.innerHTML = '';

					// 获取当前规则的自定义工艺
					const currentRule = allRules[currentRuleId];
					const currentCustomProcesses = currentRule ? currentRule.customProcesses : [];

					[...allProcesses, ...currentCustomProcesses].forEach((process) => {
						const processItem = document.createElement('div');
						processItem.className = 'process-item';
						processItem.innerHTML = `
				          <div class="process-name">${process.name}</div>
				          <div class="process-control">
				              ${renderProcessControl(process)}
				          </div>
				          ${
						process.custom
							? `
				              <div class="process-actions">
				                  <button class="icon-btn" onclick="editProcess('${process.id}')">✏️</button>
				                  <button class="icon-btn" onclick="deleteProcess('${process.id}')">🗑️</button>
				              </div>
				          `
							: ''
					}
				      `;
						processList.appendChild(processItem);
					});
				}

				// 渲染工艺控件
				function renderProcessControl(process) {
					switch (process.type) {
						case 'select':
							return `<select id="process-${process.id}" class="form-control">
				              ${process.options.map((opt) => `<option value="${opt}">${opt}</option>`).join('')}
				          </select>`;
						case 'input':
							return `<div class="input-group">
				              <input type="number" id="process-${process.id}" class="form-control" placeholder="输入数值">
				              ${process.unit ? `<span class="unit">${process.unit}</span>` : ''}
				          </div>`;
						case 'color':
							return `<div class="color-picker-wrapper">
				              <input type="color" id="process-${process.id}" class="color-picker" value="${process.default || '#000000'}">
				              <span>${process.default || '#000000'}</span>
				          </div>`;
						default:
							return '';
					}
				}

				// 添加条件规则
				function addCondition() {
					const condition = {
						id: Date.now(),
						process: '',
						operator: '=',
						value: '',
						action: '+',
						amount: 0,
					};
					// 通过 currentRuleId 获取当前规则
					allRules[currentRuleId].conditions.push(condition);
					renderConditions();
				}

				// 渲染条件规则
				function renderConditions() {
					const conditionsList = document.getElementById('conditionsList');
					conditionsList.innerHTML = '';

					const currentRule = allRules[currentRuleId];
					if (!currentRule || currentRule.conditions.length === 0) {
						conditionsList.innerHTML = '<p style="color: #5a6c7d; text-align: center;">暂无条件规则</p>';
						return;
					}

					currentRule.conditions.forEach((condition) => {
						const conditionDiv = document.createElement('div');
						conditionDiv.className = 'condition-rule';
						conditionDiv.innerHTML = `
				          <div class="condition-header">
				              <span class="condition-title">条件规则 #${condition.id}</span>
				              <button class="icon-btn" onclick="removeCondition(${condition.id})">❌</button>
				          </div>
				          <div class="condition-body">
				              <span>如果</span>
				              <select class="condition-select" onchange="updateCondition(${condition.id}, 'process', this.value)">
				                  <option value="">选择工艺</option>
				                  ${[...allProcesses, ...(currentRule.customProcesses || [])]
								.map((p) => `<option value="${p.id}" ${condition.process === p.id ? 'selected' : ''}>${p.name}</option>`)
								.join('')}
				              </select>
				              <select class="condition-select" onchange="updateCondition(${condition.id}, 'operator', this.value)">
				                  <option value="=" ${condition.operator === '=' ? 'selected' : ''}>=</option>
				                  <option value=">" ${condition.operator === '>' ? 'selected' : ''}>></option>
				                  <option value="<" ${condition.operator === '<' ? 'selected' : ''}><</option>
				                  <option value=">=" ${condition.operator === '>=' ? 'selected' : ''}>>=</option>
				                  <option value="<=" ${condition.operator === '<=' ? 'selected' : ''}<=</option>
				              </select>
				              <input type="text" class="condition-input" placeholder="值" value="${condition.value}"
				                     onchange="updateCondition(${condition.id}, 'value', this.value)">
				              <span>则价格</span>
				              <select class="condition-select" onchange="updateCondition(${condition.id}, 'action', this.value)">
				                  <option value="+" ${condition.action === '+' ? 'selected' : ''}>+</option>
				                  <option value="-" ${condition.action === '-' ? 'selected' : ''}>-</option>
				                  <option value="*" ${condition.action === '*' ? 'selected' : ''}>×</option>
				                  <option value="/" ${condition.action === '/' ? 'selected' : ''}>÷</option>
				              </select>
				              <input type="number" class="condition-input" placeholder="金额" value="${condition.amount}"
				                     onchange="updateCondition(${condition.id}, 'amount', this.value)">
				          </div>
				      `;
						conditionsList.appendChild(conditionDiv);
					});
				}

				// 更新条件
				function updateCondition(id, field, value) {
					const condition = allRules[currentRuleId].conditions.find((c) => c.id === id);
					if (condition) {
						condition[field] = field === 'amount' ? parseFloat(value) || 0 : value;
					}
				}

				// 删除条件
				function removeCondition(id) {
					allRules[currentRuleId].conditions = allRules[currentRuleId].conditions.filter((c) => c.id !== id);
					renderConditions();
				}

				// 切换标签页
				function switchTab(tab) {
					document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
					document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));

					event.target.classList.add('active');
					document.getElementById(`${tab}-tab`).classList.add('active');

					// 更新当前规则的类型
					allRules[currentRuleId].type = tab;
				}

				function toggleEditProcessInput() {
					const type = document.getElementById('editProcessType').value;
					const optionsGroup = document.getElementById('editProcessOptionsGroup');
					optionsGroup.style.display = type === 'select' ? 'block' : 'none';
				}

				// 计算价格
				function calculatePrice() {
					const length = parseFloat(document.getElementById('length-input').value) || 0;
					const width = parseFloat(document.getElementById('width-input').value) || 0;
					const area = length * width;

					let price = 0;
					const currentRule = allRules[currentRuleId];

					switch (currentRule.type) {
						case 'area':
							const basePrice = parseFloat(document.getElementById('base-price-area').value) || 0;
							const extraPrice = parseFloat(document.getElementById('extra-price-area').value) || 0;
							price = basePrice * area + extraPrice;
							break;
						case 'fixed':
							const fixedBase = parseFloat(document.getElementById('base-price-fixed').value) || 0;
							const areaFactor = parseFloat(document.getElementById('area-factor').value) || 0;
							price = fixedBase + areaFactor * area;
							break;
						case 'free':
							price = 0;
							break;
					}

					// 应用条件规则
					currentRule.conditions.forEach((condition) => {
						const processValue = getProcessValue(condition.process);
						if (evaluateCondition(processValue, condition.operator, condition.value)) {
							switch (condition.action) {
								case '+':
									price += condition.amount;
									break;
								case '-':
									price -= condition.amount;
									break;
								case '*':
									price *= condition.amount;
									break;
								case '/':
									price /= condition.amount;
									break;
							}
						}
					});

					document.getElementById('finalPrice').textContent = `¥${price.toFixed(2)}`;
				}

				// 获取工艺值
				function getProcessValue(processId) {
					const element = document.getElementById(`process-${processId}`);
					return element ? element.value : '';
				}

				// 评估条件
				function evaluateCondition(actual, operator, expected) {
					if (actual === undefined || actual === null || expected === '') return false;

					const a = parseFloat(actual) || actual;
					const e = parseFloat(expected) || expected;

					switch (operator) {
						case '=':
							return a == e;
						case '>':
							return a > e;
						case '<':
							return a < e;
						case '>=':
							return a >= e;
						case '<=':
							return a <= e;
						default:
							return false;
					}
				}

				// 显示新建规则模态框
				function showNewRuleModal() {
					document.getElementById('newRuleModal').classList.add('show');
				}

				// 显示添加工艺模态框
				function showAddProcessModal() {
					document.getElementById('addProcessModal').classList.add('show');
				}

				// 关闭模态框
				function closeModal(modalId) {
					document.getElementById(modalId).classList.remove('show');
				}

				// 创建新规则
				function createNewRule() {
					const name = document.getElementById('newRuleName').value;
					const type = document.getElementById('newRuleType').value;

					if (!name) {
						alert('请输入规则名称');
						return;
					}

					const newRule = {
						id: Date.now().toString(),
						name: name,
						type: type,
						basePrice: 0.5,
						extraPrice: 10,
						conditions: [],
						customProcesses: [], // 每个规则都有自己的自定义工艺
					};

					// 保存到allRules
					allRules[newRule.id] = newRule;

					// 重新渲染规则列表
					renderRulesList();

					// 立即切换到新规则
					selectRule(newRule.id);

					closeModal('newRuleModal');
					document.getElementById('newRuleName').value = '';
				}

				// 渲染规则列表 (新增函数，用于统一管理侧边栏)
				function renderRulesList() {
					const rulesList = document.getElementById('rulesList');
					rulesList.innerHTML = ''; // 清空列表

					Object.values(allRules).forEach((rule) => {
						const ruleItem = document.createElement('div');
						ruleItem.className = 'rule-item';
						ruleItem.dataset.ruleId = rule.id;
						ruleItem.innerHTML = `
				          <div class="rule-name">${rule.name}</div>
				          <div class="rule-type">${rule.type === 'area' ? '按面积计价' : rule.type === 'fixed' ? '一次性付费' : '免费'}</div>
				      `;
						ruleItem.onclick = () => selectRule(rule.id);
						rulesList.appendChild(ruleItem);
					});
				}

				// 选择规则 (已修复)
				function selectRule(ruleId) {
					// 检查规则是否存在
					if (!allRules[ruleId]) {
						console.error(`Rule with id ${ruleId} not found.`);
						return;
					}

					// 更新当前规则ID
					currentRuleId = ruleId;
					const currentRule = allRules[currentRuleId];

					// 更新UI选中状态
					document.querySelectorAll('.rule-item').forEach((item) => item.classList.remove('active'));
					const selectedItem = document.querySelector(`[data-rule-id="${ruleId}"]`);
					if (selectedItem) {
						selectedItem.classList.add('active');
					}

					// 更新标签页
					document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
					document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));

					const activeTab = document.querySelector(`.tab[data-tab="${currentRule.type}"]`);
					if (activeTab) {
						activeTab.classList.add('active');
						document.getElementById(`${currentRule.type}-tab`).classList.add('active');
					}

					// 重新渲染工艺和条件
					renderProcesses();
					renderConditions();
				}

				// 添加自定义工艺
				function addCustomProcess() {
					const name = document.getElementById('processName').value;
					const type = document.getElementById('processType').value;
					const options = document
						.getElementById('processOptions')
						.value.split('\n')
						.filter((o) => o.trim());

					if (!name) {
						alert('请输入工艺名称');
						return;
					}

					if (type === 'select' && options.length === 0) {
						alert('请添加选项值');
						return;
					}

					const process = {
						id: 'custom_' + Date.now(),
						name: name,
						type: type,
						options: options,
						custom: true,
					};

					// 添加到当前规则的自定义工艺
					if (!allRules[currentRuleId].customProcesses) {
						allRules[currentRuleId].customProcesses = [];
					}
					allRules[currentRuleId].customProcesses.push(process);

					renderProcesses();
					renderConditions();

					closeModal('addProcessModal');
					document.getElementById('processName').value = '';
					document.getElementById('processOptions').value = '';
				}

				// 删除自定义工艺
				function deleteProcess(processId) {
					if (confirm('确定要删除这个工艺吗？')) {
						const currentRule = allRules[currentRuleId];
						if (currentRule && currentRule.customProcesses) {
							currentRule.customProcesses = currentRule.customProcesses.filter((p) => p.id !== processId);
							renderProcesses();
							renderConditions();
						}
					}
				}

				// 编辑自定义工艺
				function editProcess(processId) {
					const currentRule = allRules[currentRuleId];
					if (!currentRule || !currentRule.customProcesses) return;

					const process = currentRule.customProcesses.find((p) => p.id === processId);
					if (!process) return;

					// 填充编辑表单
					document.getElementById('editProcessId').value = processId;
					document.getElementById('editProcessName').value = process.name;
					document.getElementById('editProcessType').value = process.type;

					// 如果是选择类型，显示选项
					if (process.type === 'select') {
						document.getElementById('editProcessOptionsGroup').style.display = 'block';
						document.getElementById('editProcessOptions').value = process.options ? process.options.join('\n') : '';
					} else {
						document.getElementById('editProcessOptionsGroup').style.display = 'none';
					}

					// 显示编辑模态框
					document.getElementById('editProcessModal').classList.add('show');
				}

				// 保存编辑的自定义工艺
				function saveEditProcess() {
					const processId = document.getElementById('editProcessId').value;
					const name = document.getElementById('editProcessName').value;
					const type = document.getElementById('editProcessType').value;
					const options = document
						.getElementById('editProcessOptions')
						.value.split('\n')
						.filter((o) => o.trim());

					if (!name) {
						alert('请输入工艺名称');
						return;
					}

					if (type === 'select' && options.length === 0) {
						alert('请添加选项值');
						return;
					}

					const currentRule = allRules[currentRuleId];
					if (!currentRule || !currentRule.customProcesses) return;

					// 找到要编辑的工艺
					const processIndex = currentRule.customProcesses.findIndex((p) => p.id === processId);
					if (processIndex === -1) return;

					// 更新工艺信息
					currentRule.customProcesses[processIndex] = {
						...currentRule.customProcesses[processIndex],
						name: name,
						type: type,
						options: options,
					};

					renderProcesses();
					renderConditions();

					closeModal('editProcessModal');
				}

				// 切换工艺输入类型（编辑模态框）
				function toggleEditProcessInput() {
					const type = document.getElementById('editProcessType').value;
					const optionsGroup = document.getElementById('editProcessOptionsGroup');
					optionsGroup.style.display = type === 'select' ? 'block' : 'none';
				}

				// 切换工艺输入类型（添加模态框）
				function toggleProcessInput() {
					const type = document.getElementById('processType').value;
					const optionsGroup = document.getElementById('processOptionsGroup');
					optionsGroup.style.display = type === 'select' ? 'block' : 'none';
				}

				// 导出规则
				function exportRules() {
					// 1. 创建一个新对象来存储要导出的规则，避免直接修改原始数据
					const rulesToExport = { ...allRules };

					// 2. 删除默认规则
					if (rulesToExport.default) {
						delete rulesToExport.default;
					}

					// 3. 将规则对象转换为数组，简化结构
					const exportedRulesArray = Object.values(rulesToExport);

					const exportData = {
						// currentRuleId 现在需要检查它是否是默认规则，如果是，则不导出
						currentRuleId: currentRuleId !== 'default' && allRules[currentRuleId] ? currentRuleId : null,
						// 将 allRules 对象替换为 rules 数组
						rules: exportedRulesArray,
						timestamp: new Date().toISOString(),
					};

					const blob = new Blob([JSON.stringify(exportData, null, 2)], {
						type: 'application/json',
					});
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = `pcb-pricing-rules-${Date.now()}.json`;
					a.click();
					URL.revokeObjectURL(url);
				}
		/**
		 * 导出规则 - 默认为 .xlsx，传入 'json' 参数则导出 .json
		 * @param {string} format - 可选 'json' 或 'xlsx'（默认）
		 */
		function exportRules(format = 'xlsx') {
			const rulesToExport = { ...allRules };

			// 删除 default 规则（不导出）
			if (rulesToExport.default) {
				delete rulesToExport.default;
			}

			const exportedRulesArray = Object.values(rulesToExport);

			const commonData = {
				timestamp: new Date().toISOString(),
				currentRuleId: currentRuleId !== 'default' && allRules[currentRuleId] ? currentRuleId : null,
				rules: exportedRulesArray,
			};

			// ========== JSON 导出 ==========
			if (format === 'json') {
				const blob = new Blob([JSON.stringify(commonData, null, 2)], {
					type: 'application/json',
				});
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `pcb-pricing-rules-${Date.now()}.json`;
				a.click();
				URL.revokeObjectURL(url);
				return;
			}

			// ========== XLSX 导出（默认）==========
			const rows = [];
			exportedRulesArray.forEach((rule) => {
				const flat = flattenWithPaths(rule);
				rows.push(flat);
			});

			const headers = ["Field Path", ...exportedRulesArray.map(r => r.name || r.id)];
			const allPaths = [...new Set(rows.flatMap(Object.keys))].sort();

			const worksheetData = [headers];
			allPaths.forEach(path => {
				const row = [path];
				rows.forEach(flatObj => {
					row.push(stringifyValue(flatObj[path]));
				});
				worksheetData.push(row);
			});

			const ws = XLSX.utils.aoa_to_sheet(worksheetData);
			const wb = XLSX.utils.book_new();
			XLSX.utils.book_append_sheet(wb, ws, "Pricing Rules");
			XLSX.writeFile(wb, `pcb-pricing-rules-${Date.now()}.xlsx`);
		}

		/**
		 * 导入规则 - 默认为 .xlsx，若文件是 .json 则自动识别并处理
		 * @param {string} format - 可选 'json' 或 'xlsx'，但会优先根据文件扩展名判断
		 */
		function importRules(format) {
			const input = document.createElement('input');
			input.type = 'file';
			input.accept = '.json,.xlsx';
			input.onchange = function (e) {
				const file = e.target.files[0];
				if (!file) return;

				const reader = new FileReader();

				reader.onload = function (event) {
					try {
						let data = null;

						// 自动判断格式，或由 format 参数覆盖
						const useJson = format === 'json' ||
							file.name.endsWith('.json');

						if (useJson) {
							data = JSON.parse(event.target.result);
							processImportedData(data);
						} else {
							// 必须是 ArrayBuffer 才能解析 xlsx
							const arrayBuffer = event.target.result;
							const workbook = XLSX.read(arrayBuffer, { type: 'array' });
							const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
							data = parseXlsxSheet(firstSheet);
							processImportedData(data);
						}
					} catch (error) {
						console.error('导入失败:', error);
						alert('导入失败：文件解析错误或格式不正确');
					}
				};

				// 读取模式：xlsx 需要 arraybuffer，json 用 text
				if (file.name.endsWith('.xlsx')) {
					reader.readAsArrayBuffer(file);
				} else {
					reader.readAsText(file);
				}

				input.value = ''; // 清空输入以便重复选择
			};
			input.click();
		}

		// ==================== 辅助函数 ====================

		/**
		 * 将对象按路径展平：{ a: { b: 1 } } → { "a.b": 1 }
		 */
		function flattenWithPaths(obj, prefix = '', result = {}) {
			for (const key in obj) {
				if (!obj.hasOwnProperty(key)) continue;

				const value = obj[key];
				const path = prefix ? `${prefix}.${key}` : key;

				if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
					flattenWithPaths(value, path, result);
				} else {
					result[path] = value;
				}
			}
			return result;
		}

		/**
		 * 安全序列化值用于表格显示
		 */
		function stringifyValue(val) {
			if (val == null) return "";
			if (typeof val === "string") return val;
			if (typeof val === "number" || typeof val === "boolean") return String(val);
			return JSON.stringify(val);
		}

		/**
		 * 尝试还原原始类型（数字、布尔、null、JSON 对象等）
		 */
		function parseValue(val) {
			if (val == null || val === "") return null;
			const str = String(val).trim();

			if (str.toLowerCase() === 'true') return true;
			if (str.toLowerCase() === 'false') return false;

			const num = Number(str);
			if (!isNaN(num)) return num;

			try {
				return JSON.parse(str);
			} catch (e) {
				return str;
			}
		}

		/**
		 * 按路径设置对象属性：setByPath(obj, 'a.b.c', 42)
		 */
		function setByPath(obj, path, value) {
			const keys = path.split('.');
			let current = obj;
			for (let i = 0; i < keys.length - 1; i++) {
				const k = keys[i];
				if (!(k in current)) current[k] = {};
				current = current[k];
			}
			current[keys[keys.length - 1]] = value;
		}

		/**
		 * 解析 XLSX 表格为规则数组
		 */
		function parseXlsxSheet(sheet) {
			const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
			if (data.length < 2) throw new Error("Excel 文件为空");

			const headers = data[0]; // ["Field Path", "Rule1", "Rule2"...]
			const rulesData = [];

			for (let ri = 1; ri < data.length; ri++) {
				const row = data[ri];
				const path = row[0];
				if (!path) continue;

				for (let ci = 1; ci < headers.length; ci++) {
					const ruleName = headers[ci];
					const rawValue = row[ci];

					if (!rulesData[ci - 1]) {
						rulesData[ci - 1] = { id: generateId(), name: ruleName };
					}

					setByPath(rulesData[ci - 1], path, parseValue(rawValue));
				}
			}

			return {
				timestamp: new Date().toISOString(),
				rules: rulesData,
				currentRuleId: null // 后续逻辑自动选择
			};
		}

		/**
		 * 简单 ID 生成器
		 */
		function generateId() {
			return 'rule_' + Date.now() + Math.random().toString(36).substr(2, 5);
		}

		/**
		 * 处理导入的数据，合并到 allRules 并刷新 UI
		 */
		function processImportedData(data) {
			// 清除非 default 规则
			Object.keys(allRules).forEach(id => {
				if (id !== 'default') delete allRules[id];
			});

			// 合并新规则
			if (data.rules && Array.isArray(data.rules)) {
				data.rules.forEach(rule => {
					if (rule.id) {
						allRules[rule.id] = rule;
					}
				});
			}

			// 设置当前规则
			let newCurrentRuleId = null;
			if (data.currentRuleId && allRules[data.currentRuleId]) {
				newCurrentRuleId = data.currentRuleId;
			} else {
				const nonDefaultIds = Object.keys(allRules).filter(id => id !== 'default');
				newCurrentRuleId = nonDefaultIds.length > 0 ? nonDefaultIds[0] : 'default';
			}

			selectRule(newCurrentRuleId);
			renderRulesList();
			alert('规则导入成功！');
		}

				// PCB识别函数
				async function GetPcbInfomation() {
					try {
						const ids = await eda.pcb_PrimitivePolyline.getAllPrimitiveId(null, 11);
						eda.pcb_SelectControl.doSelectPrimitives(ids);
						let PCB_Infomation = await eda.pcb_SelectControl.getSelectedPrimitives();
						PCB_Infomation = PCB_Infomation[0];
						let width = PCB_Infomation.width * 0.254;
						let height = PCB_Infomation.height * 0.254;
						const All_Layers = await eda.pcb_Layer.getAllLayers();

						document.getElementById('width-input').value = Math.round((width / 10) * 100) / 100;
						document.getElementById('length-input').value = Math.round((height / 10) * 100) / 100;
						document.getElementById('layer-input').value = calcLayers(All_Layers);
						eda.sys_Message.showToastMessage('识别成功', 'success', 2);
						// 自动计算价格
						calculatePrice();
					} catch (error) {
						eda.sys_Message.showToastMessage('未识别到板框或板框过多，请手动框选并重试', 'error', 2);
					}
				}

				// 获取PCB层数
				function calcLayers(layers) {
					let count = 0;
					const ids = [
						1,
						2,
						...Array.from(
							{
								length: 32,
							},
							(_, i) => i + 15,
						),
					];
					for (const layer of layers) {
						const id = parseInt(layer.id);
						if (ids.includes(id) && layer.layerStatus === 1) {
							count++;
						}
					}
					return count;
				}

				// 监听颜色选择器变化
				document.addEventListener('change', function (e) {
					if (e.target.type === 'color') {
						const span = e.target.nextElementSibling;
						if (span) {
							span.textContent = e.target.value;
						}
					}
				});
	</script>
</html>
